<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tính toán khoản vay</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .step-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.95);
        }
        .step-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .hidden {
            display: none;
        }
        .required-income {
            background-color: #e8f4ff;
            border: 2px solid #0d6efd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .required-income h5 {
            color: #0d6efd;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        .required-income-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d6efd;
        }
        body {
            background-image: url('images/logo.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: contain;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .container {
            position: relative;
            z-index: 1;
        }
        .menu-btn {
            box-shadow: 0 4px 16px rgba(34,139,34,0.12), 0 1.5px 4px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s, transform 0.2s, background 0.2s;
            cursor: pointer;
            font-size: 1.08rem;
            font-weight: bold;
            padding: 0.7rem 1.2rem;
            border-radius: 10px;
        }
        .menu-btn:hover, .menu-btn:focus {
            box-shadow: 0 8px 24px rgba(34,139,34,0.18), 0 2px 8px rgba(0,0,0,0.12);
            transform: translateY(-2px) scale(1.03);
            background: #e6f4ea !important;
        }
        .blink-cursor {
            animation: blink-cursor 1s steps(2, start) infinite;
            color: #228B22;
            font-size: 1.2em;
            transform: scale(3);
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes blink-cursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex flex-column align-items-start mb-3 gap-2">
            <button type="button" class="btn btn-primary btn-sm fw-bold menu-btn" style="background-color: #1e90ff; border-color: #1e90ff; min-width: 260px;" onclick="window.location.href='projects.html'">
                <i class="bi bi-hand-index-thumb-fill blink-cursor" style="color:#228B22;"></i>DANH MỤC CÁC DỰ ÁN LIÊN KẾT VỚI VCB THỦ THIÊM
            </button>
            <button type="button" class="btn btn-danger btn-sm fw-bold menu-btn" style="background-color:#e75480;border:none;min-width:260px;" onclick="window.location.href='laisuat.html'">
                <i class="bi bi-hand-index-thumb-fill blink-cursor" style="color:#228B22;"></i>CÁC GÓI LÃI SUẤT CHO VAY KHCN HIỆN HÀNH
            </button>
            <button type="button" class="btn btn-primary btn-sm fw-bold menu-btn" style="background-color: #228B22; border-color: #228B22; color: #fff; min-width: 260px;" onclick="window.location.href='hosovay.html'">
                <i class="bi bi-hand-index-thumb-fill blink-cursor" style="color:#fff;"></i>DANH MỤC HỒ SƠ VAY VỐN KHÁCH HÀNG CUNG CẤP
            </button>
            <button type="button" class="btn btn-success btn-sm fw-bold menu-btn" style="background-color:#fffbe6;color:#b8860b;border:none;min-width:260px;" onclick="window.location.href='nhomkhachhang.html'">
                <i class="bi bi-hand-index-thumb-fill blink-cursor" style="color:#228B22;"></i>NHÓM KHÁCH HÀNG CÓ KHẢ NĂNG TRẢ NỢ KHÁC
            </button>
        </div>
        <h1 class="text-center mb-4">Tính toán khoản vay</h1>
        
        <!-- Step 1: Thông tin khoản vay -->
        <div class="step-container">
            <div class="step-header">
                <h3>Bước 1: Thông tin khoản vay</h3>
            </div>
            <form id="loanForm">
                <div class="mb-3">
                    <label for="assetValue" class="form-label">Giá trị tài sản mua/Tài sản bảo đảm (VND)</label>
                    <input type="text" class="form-control" id="assetValue" required min="0" max="999999999999">
                </div>
                <div class="mb-3">
                    <label for="loanRate" class="form-label">Tỉ lệ cho vay (%)</label>
                    <input type="number" class="form-control" id="loanRate" min="0" max="100" step="0.1" value="70" required>
                </div>
                <div class="alert alert-info">
                    <h5>Kết quả tính toán:</h5>
                    <p>Số tiền cho vay tối đa: <span id="maxLoan">0 VND</span></p>
                </div>
                <div class="mb-3">
                    <label for="loanAmount" class="form-label">Số tiền Khách hàng đề xuất (VND)</label>
                    <input type="text" class="form-control" id="loanAmount" required min="0" max="999999999999">
                    <div id="errorMessage" class="text-danger" style="display: none;">Số tiền đề xuất vượt quá hạn mức cho vay!</div>
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Thời hạn vay (tháng)</label>
                    <input type="number" class="form-control" id="loanTerm" required min="1">
                </div>
            </form>
        </div>

        <!-- Step 2: Khoản vay khác -->
        <div class="step-container">
            <div class="step-header">
                <h3>Bước 2: Khoản vay khác</h3>
            </div>
            <form id="otherLoanForm">
                <div class="mb-3">
                    <label class="form-label">Có khoản vay khác/Thẻ tín dụng không?</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="hasOtherLoan" id="hasOtherLoanYes" value="yes">
                        <label class="form-check-label" for="hasOtherLoanYes">Có</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="hasOtherLoan" id="hasOtherLoanNo" value="no" checked>
                        <label class="form-check-label" for="hasOtherLoanNo">Không</label>
                    </div>
                </div>

                <div id="otherLoanDetails" class="hidden">
                    <div class="mb-3">
                        <label for="otherLoanAmount" class="form-label">Số tiền vay/dư nợ còn lại (VND)</label>
                        <input type="text" class="form-control" id="otherLoanAmount" min="0" max="999999999999">
                    </div>
                    <div class="mb-3">
                        <label for="otherLoanRate" class="form-label">Lãi suất (%)</label>
                        <input type="number" class="form-control" id="otherLoanRate" min="0" max="100" step="0.1">
                    </div>
                    <div class="mb-3">
                        <label for="otherLoanTerm" class="form-label">Thời hạn vay còn lại (tháng)</label>
                        <input type="number" class="form-control" id="otherLoanTerm" min="1" placeholder="Nhập số tháng còn lại">
                    </div>
                    <div class="mb-3">
                        <label for="creditCardPayment" class="form-label">Số tiền trả nợ thẻ tín dụng bình quân hàng tháng(VND)</label>
                        <input type="text" class="form-control" id="creditCardPayment" min="0" max="999999999999" placeholder="Nhập số tiền">
                    </div>
                </div>
            </form>
        </div>

        <!-- Step 3: Thu nhập -->
        <div class="step-container">
            <div class="step-header">
                <h3>Bước 3: Thu nhập</h3>
            </div>
            <form id="incomeForm">
                <div class="mb-3">
                    <label for="incomeAmount" class="form-label">Tổng thu nhập bình quân hàng tháng (bao gồm cả vợ/chồng)</label>
                    <input type="text" class="form-control" id="incomeAmount" min="0" max="999999999999" placeholder="Nhập tổng thu nhập (VND)">
                </div>
            </form>
        </div>

        <!-- Kết quả -->
        <div class="step-container">
            <div class="step-header">
                <h3>Kết quả tính toán</h3>
            </div>
            <div class="alert alert-info">
                <h5>Chi tiết khoản vay:</h5>
                <div style="border: 2px solid #228B22; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                    <p>Gốc hàng tháng: <span id="monthlyPrincipal">0 VND</span></p>
                    <p>Lãi hàng tháng (tạm tính theo lãi suất thả nổi 9%): <span id="monthlyInterest">0 VND</span></p>
                    <p>Tổng gốc, lãi phải trả hàng tháng tại VCB: <span id="monthlyTotal">0 VND</span></p>
                </div>
                <p>Khoản vay khác hàng tháng: <span id="otherLoanMonthly">0 VND</span></p>
                <p>Số tiền trả nợ thẻ tín dụng tối thiểu (10%): <span id="creditCardMonthly">0 VND</span></p>
                <p>Tổng nợ phải trả hàng tháng: <span id="totalMonthlyPayment">0 VND</span></p>
                <p>Hệ số trả nợ: <span id="debtRatio">60%</span></p>
                <div class="required-income">
                    <h5>Thu nhập cần chứng minh:</h5>
                    <p class="required-income-value"><span id="requiredIncome">0 VND</span></p>
                    <div id="incomeStatus"></div>
                </div>
            </div>
        </div>

        <!-- Nút điều hướng -->
        <div class="d-flex justify-content-between mb-4">
            <button type="button" class="btn btn-warning btn-lg" onclick="resetForm()">
                <i class="bi bi-arrow-counterclockwise"></i> Bắt đầu lại
            </button>
            <button type="button" class="btn btn-primary btn-lg" onclick="window.location.href='schedule.html'">
                <i class="bi bi-calendar-check"></i> Xem lịch trả nợ chi tiết
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script>
        // Hàm chuyển đổi số thành định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Hàm định dạng số với dấu chấm ngăn cách
        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Hàm chuyển đổi chuỗi số có dấu chấm thành số
        function parseFormattedNumber(str) {
            return parseInt(str.replace(/\./g, '')) || 0;
        }

        // Khởi tạo dữ liệu
        let loanData = JSON.parse(localStorage.getItem('loanData')) || {};

        // Tính toán số tiền cho vay tối đa
        const assetValueInput = document.getElementById('assetValue');
        const loanRateInput = document.getElementById('loanRate');
        const maxLoanSpan = document.getElementById('maxLoan');
        const loanAmountInput = document.getElementById('loanAmount');
        const errorMessage = document.getElementById('errorMessage');
        const otherLoanAmountInput = document.getElementById('otherLoanAmount');
        const creditCardPaymentInput = document.getElementById('creditCardPayment');
        const loanTermInput = document.getElementById('loanTerm');
        const otherLoanRateInput = document.getElementById('otherLoanRate');
        const otherLoanTermInput = document.getElementById('otherLoanTerm');
        const incomeAmountInput = document.getElementById('incomeAmount');
        // Thêm khai báo cho radio button khoản vay khác
        const hasOtherLoanYes = document.getElementById('hasOtherLoanYes');
        const hasOtherLoanNo = document.getElementById('hasOtherLoanNo');
        const otherLoanDetails = document.getElementById('otherLoanDetails');

        // Thêm định dạng số cho các input tiền
        [assetValueInput, loanAmountInput].forEach(input => {
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\./g, '');
                if (value) {
                    // Giới hạn độ dài số là 12 chữ số
                    if (value.length > 12) {
                        value = value.slice(0, 12);
                    }
                    value = parseInt(value);
                    e.target.value = formatNumber(value);
                }
            });
        });
        // Đảm bảo luôn cập nhật số tiền cho vay tối đa khi nhập giá trị tài sản hoặc tỉ lệ cho vay
        assetValueInput.addEventListener('input', calculateMaxLoan);
        loanRateInput.addEventListener('input', calculateMaxLoan);

        function calculateMaxLoan() {
            const assetValue = parseFormattedNumber(assetValueInput.value);
            let loanRate = parseFloat(loanRateInput.value) || 0;
            const loanAmount = parseFormattedNumber(loanAmountInput.value);
            
            // Chỉ tính và kiểm tra khi có đủ cả giá trị tài sản và tỉ lệ cho vay
            if (assetValue > 0 && loanRate > 0) {
                if (loanRate < 0) loanRate = 0;
                if (loanRate > 100) loanRate = 100;
                loanRateInput.value = loanRate;
                // Cập nhật lại biến loanRate sau khi giới hạn
                loanRate = parseFloat(loanRateInput.value) || 0;
                
                const maxLoan = (assetValue * loanRate) / 100;
                maxLoanSpan.textContent = formatCurrency(Math.round(maxLoan));
                
                // Kiểm tra số tiền đề xuất chỉ khi có nhập số tiền
                if (loanAmount > 0) {
                    if (loanAmount > maxLoan) {
                        errorMessage.style.display = 'block';
                    } else {
                        errorMessage.style.display = 'none';
                    }
                } else {
                    errorMessage.style.display = 'none';
                }
            } else {
                // Nếu không có đủ thông tin, ẩn thông báo lỗi và không kiểm tra hạn mức
                errorMessage.style.display = 'none';
                maxLoanSpan.textContent = '0 VND';
            }
        }

        // Thêm event listener cho input số tiền đề xuất
        loanAmountInput.addEventListener('input', function(e) {
            const loanAmount = parseFormattedNumber(e.target.value);
            const assetValue = parseFormattedNumber(assetValueInput.value);
            const loanRate = parseFloat(loanRateInput.value) || 0;
            
            // Nếu có nhập số tiền đề xuất
            if (loanAmount > 0) {
                // Nếu có đủ thông tin tài sản và tỉ lệ cho vay
                if (assetValue > 0 && loanRate > 0) {
                    const maxLoan = (assetValue * loanRate) / 100;
                    if (loanAmount > maxLoan) {
                        errorMessage.style.display = 'block';
                    } else {
                        errorMessage.style.display = 'none';
                    }
                } else {
                    // Nếu không có đủ thông tin, cho phép nhập số tiền đề xuất và không hiển thị cảnh báo
                    errorMessage.style.display = 'none';
                }
            } else {
                errorMessage.style.display = 'none';
            }
        });

        // Thêm event listener cho input giá trị tài sản và tỉ lệ cho vay
        [assetValueInput, loanRateInput].forEach(input => {
            input.addEventListener('input', function() {
                const assetValue = parseFormattedNumber(assetValueInput.value);
                const loanRate = parseFloat(loanRateInput.value) || 0;
                const loanAmount = parseFormattedNumber(loanAmountInput.value);
                
                // Nếu có đủ thông tin và có số tiền đề xuất
                if (assetValue > 0 && loanRate > 0 && loanAmount > 0) {
                    const maxLoan = (assetValue * loanRate) / 100;
                    if (loanAmount > maxLoan) {
                        errorMessage.style.display = 'block';
                    } else {
                        errorMessage.style.display = 'none';
                    }
                }
            });
        });

        // Xử lý khoản vay khác
        function toggleOtherLoanDetails() {
            otherLoanDetails.classList.toggle('hidden', !hasOtherLoanYes.checked);
        }

        hasOtherLoanYes.addEventListener('change', toggleOtherLoanDetails);
        hasOtherLoanNo.addEventListener('change', toggleOtherLoanDetails);

        // Tính toán khoản vay
        function calculateLoan() {
            const loanAmount = parseFormattedNumber(loanAmountInput.value);
            const term = parseInt(loanTermInput.value) || 0;
            const interestRate = 9.0; // Lãi suất cố định 9%

            if (loanAmount > 0 && term > 0) {
                const monthlyRate = interestRate / 12 / 100;
                const monthlyPayment = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, term) / (Math.pow(1 + monthlyRate, term) - 1);
                const monthlyPrincipal = loanAmount / term;
                const monthlyInterest = monthlyPayment - monthlyPrincipal;

                // Tính khoản vay khác
                let otherLoanMonthly = 0;
                if (hasOtherLoanYes.checked) {
                    const otherAmount = parseFormattedNumber(otherLoanAmountInput.value);
                    const otherRate = parseFloat(otherLoanRateInput.value) || 0;
                    const otherTerm = parseInt(otherLoanTermInput.value) || 0;
                    
                    if (otherAmount > 0 && otherRate > 0 && otherTerm > 0) {
                        const otherMonthlyRate = otherRate / 12 / 100;
                        // Tính số tiền trả hàng tháng dựa trên số tiền vay và thời hạn còn lại
                        otherLoanMonthly = otherAmount * otherMonthlyRate * Math.pow(1 + otherMonthlyRate, otherTerm) / (Math.pow(1 + otherMonthlyRate, otherTerm) - 1);
                    }
                }

                // Tính thẻ tín dụng
                const creditCardMonthly = hasOtherLoanYes.checked ? parseFormattedNumber(creditCardPaymentInput.value) * 0.1 : 0;

                // Tính tổng nợ phải trả
                const totalMonthlyPayment = monthlyPayment + otherLoanMonthly + creditCardMonthly;

                // Tính thu nhập cần chứng minh
                let debtRatio = 0.6;
                const incomeAmount = parseFormattedNumber(incomeAmountInput.value);
                if (incomeAmount >= 60000000) {
                    debtRatio = 0.7;
                }
                const requiredIncome = totalMonthlyPayment / debtRatio;

                // Cập nhật kết quả
                document.getElementById('monthlyPrincipal').textContent = formatCurrency(Math.round(monthlyPrincipal));
                document.getElementById('monthlyInterest').textContent = formatCurrency(Math.round(monthlyInterest));
                document.getElementById('monthlyTotal').textContent = formatCurrency(Math.round(monthlyPayment));
                document.getElementById('otherLoanMonthly').textContent = formatCurrency(Math.round(otherLoanMonthly));
                document.getElementById('creditCardMonthly').textContent = formatCurrency(Math.round(creditCardMonthly));
                document.getElementById('totalMonthlyPayment').textContent = formatCurrency(Math.round(totalMonthlyPayment));
                document.getElementById('debtRatio').textContent = (debtRatio * 100) + '%';
                document.getElementById('requiredIncome').textContent = formatCurrency(Math.round(requiredIncome));

                // Thông báo kiểm tra thu nhập
                const incomeStatus = document.getElementById('incomeStatus');
                if (incomeAmount > 0) {
                    if (incomeAmount >= requiredIncome) {
                        incomeStatus.innerHTML = '<span style="color:#228B22;font-weight:bold;font-size:1.1rem;"><i class="bi bi-patch-check-fill" style="font-size:1.5rem;vertical-align:middle;color:#228B22;"></i> THU NHẬP ĐÁP ỨNG ĐIỀU KIỆN VAY</span>';
                    } else {
                        incomeStatus.innerHTML = `
                            <span style="color:#b8860b;font-weight:bold;font-size:1.1rem;background:#fffbe6;padding:6px 12px;border-radius:8px;display:inline-block;margin-bottom:10px;">
                                THU NHẬP CHƯA ĐÁP ỨNG ĐIỀU KIỆN VAY
                            </span>
                            <div>
                                <button type="button" class="btn btn-warning btn-lg" onclick="window.location.href='nhomkhachhang.html'" style="margin-top:10px;">
                                    <i class="bi bi-search"></i> RÀ SOÁT LẠI BỘ ĐIỀU KIỆN
                                </button>
                            </div>`;
                    }
                } else {
                    incomeStatus.innerHTML = '';
                }

                // Lưu dữ liệu
                loanData = {
                    assetValue: parseFormattedNumber(assetValueInput.value),
                    loanRate: parseFloat(loanRateInput.value),
                    loanAmount: loanAmount,
                    loanTerm: term,
                    hasOtherLoan: hasOtherLoanYes.checked,
                    otherLoanAmount: parseFormattedNumber(otherLoanAmountInput.value),
                    otherLoanRate: parseFloat(otherLoanRateInput.value) || 0,
                    otherLoanTerm: parseInt(otherLoanTermInput.value) || 0,
                    creditCardPayment: parseFormattedNumber(creditCardPaymentInput.value),
                    incomeAmount: incomeAmount,
                    monthlyPayment: Math.round(monthlyPayment),
                    otherLoanMonthly: Math.round(otherLoanMonthly),
                    creditCardMonthly: Math.round(creditCardMonthly),
                    totalMonthlyPayment: Math.round(totalMonthlyPayment),
                    requiredIncome: Math.round(requiredIncome)
                };
                localStorage.setItem('loanData', JSON.stringify(loanData));
            }
        }

        // Thêm event listeners cho tất cả các input
        const inputs = [
            loanAmountInput, loanTermInput, otherLoanAmountInput, 
            otherLoanRateInput, otherLoanTermInput, creditCardPaymentInput,
            incomeAmountInput
        ];
        inputs.forEach(input => input.addEventListener('input', calculateLoan));

        // Hàm reset form
        function resetForm() {
            // Reset tất cả các input về giá trị mặc định
            document.getElementById('assetValue').value = '';
            document.getElementById('loanRate').value = '70';
            document.getElementById('loanAmount').value = '';
            document.getElementById('loanTerm').value = '';
            document.getElementById('otherLoanAmount').value = '';
            document.getElementById('otherLoanRate').value = '';
            document.getElementById('otherLoanTerm').value = '';
            document.getElementById('creditCardPayment').value = '';
            
            // Reset radio buttons
            document.getElementById('hasOtherLoanNo').checked = true;
            
            // Ẩn phần khoản vay khác
            document.getElementById('otherLoanDetails').classList.add('hidden');
            
            // Reset kết quả tính toán
            document.getElementById('maxLoan').textContent = '0 VND';
            document.getElementById('monthlyPrincipal').textContent = '0 VND';
            document.getElementById('monthlyInterest').textContent = '0 VND';
            document.getElementById('monthlyTotal').textContent = '0 VND';
            document.getElementById('otherLoanMonthly').textContent = '0 VND';
            document.getElementById('creditCardMonthly').textContent = '0 VND';
            document.getElementById('totalMonthlyPayment').textContent = '0 VND';
            document.getElementById('debtRatio').textContent = '60%';
            document.getElementById('requiredIncome').textContent = '0 VND';
            document.getElementById('incomeStatus').innerHTML = '';
            
            // Xóa dữ liệu đã lưu
            localStorage.removeItem('loanData');
        }

        // Load dữ liệu đã lưu khi trang được tải
        window.addEventListener('load', function() {
            resetForm();
        });
    </script>
</body>
</html> 