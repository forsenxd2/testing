<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch trả nợ chi tiết</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .step-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.95);
        }
        .step-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .hidden {
            display: none;
        }
        body {
            background-image: url('images/logo.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: contain;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .container {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex flex-column align-items-end mb-3 gap-2">
            <button type="button" class="btn btn-primary btn-sm fw-bold" style="background-color: #1e90ff; border-color: #1e90ff; min-width: 260px;" onclick="window.location.href='projects.html'">
                DANH MỤC CÁC DỰ ÁN MÀ VCB THỦ THIÊM THỰC HIỆN CHO VAY KHÁCH HÀNG CÁ NHÂN
            </button>
            <button type="button" class="btn btn-primary btn-sm fw-bold" style="background-color: #ffd700; border-color: #ffd700; color: #000; min-width: 260px;" onclick="window.location.href='hosovay.html'">
                DANH MỤC HỒ SƠ VAY VỐN KHÁCH HÀNG CUNG CẤP
            </button>
            <button type="button" class="btn btn-danger btn-sm fw-bold" style="background-color:#e75480;border:none;min-width:260px;" onclick="window.location.href='laisuat.html'">
                Các gói Lãi suất cho vay KHCN hiện hành
            </button>
        </div>
        <h1 class="text-center mb-4">Lịch trả nợ chi tiết</h1>

        <!-- Form nhập liệu -->
        <div class="step-container" id="inputForm">
            <div class="step-header">
                <h3>Thông tin khoản vay</h3>
            </div>
            <form id="loanForm">
                <div class="mb-3">
                    <label for="assetValue" class="form-label">Giá trị tài sản mua/Tài sản bảo đảm (VND)</label>
                    <input type="text" class="form-control" id="assetValue" required min="0" max="999999999999">
                </div>
                <div class="mb-3">
                    <label for="loanAmount" class="form-label">Số tiền vay (VND)</label>
                    <input type="text" class="form-control" id="loanAmount" required min="0" max="999999999999">
                </div>
                <div id="fixedPackageHighlight" class="mb-3 p-3 border border-primary rounded" style="background-color: #fffacd;">
                    <label for="fixedPackage" class="form-label fw-bold" style="font-size:1.15rem; color:#0d6efd;">
                        <i class="bi bi-star-fill"></i> Chọn gói cố định lãi suất
                    </label>
                    <select class="form-select" id="fixedPackage">
                        <option value="12">Cố định 12 tháng (6%/năm)</option>
                        <option value="18">Cố định 18 tháng (6.3%/năm)</option>
                        <option value="24">Cố định 24 tháng (6.5%/năm)</option>
                        <option value="36">Cố định 36 tháng (8%/năm)</option>
                        <option value="young_1">Gói ưu đãi đặc biệt cho người trẻ 1 (5.5% - 36 tháng, ân hạn gốc tối đa 5 năm)</option>
                        <option value="young_2">Gói ưu đãi đặc biệt cho người trẻ 2 (5.2% - 12 tháng, 6.6% - 24 tháng, ân hạn gốc tối đa 5 năm)</option>
                    </select>
                    <div id="gracePeriodGroup" class="mt-3" style="display:none;">
                        <label for="gracePeriod" class="form-label">Chọn thời gian ân hạn gốc (tháng)</label>
                        <select class="form-select" id="gracePeriod">
                            <option value="12">12 tháng (1 năm)</option>
                            <option value="24">24 tháng (2 năm)</option>
                            <option value="36">36 tháng (3 năm)</option>
                            <option value="48">48 tháng (4 năm)</option>
                            <option value="60">60 tháng (5 năm)</option>
                        </select>
                    </div>
                    <div id="graceError" class="text-danger mt-2" style="display:none;">Thời hạn vay phải lớn hơn hoặc bằng thời gian ân hạn gốc!</div>
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Thời hạn vay (tháng)</label>
                    <input type="number" class="form-control" id="loanTerm" required min="1">
                </div>
                <div class="mb-3">
                    <label for="afterFixedRate" class="form-label">Lãi suất sau thời gian ưu đãi tạm tính (%/năm)</label>
                    <input type="number" class="form-control" id="afterFixedRate" min="0" step="0.1" value="9.0">
                </div>
                <div class="text-center">
                    <button type="button" class="btn btn-primary" onclick="calculateSchedule()">Xem lịch trả nợ</button>
                </div>
            </form>
        </div>

        <!-- Bảng lịch trả nợ -->
        <div class="step-container" id="scheduleTable" style="display: none;">
            <div class="step-header">
                <h3>Chi tiết lịch trả nợ(tạm tính)</h3>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Kỳ</th>
                            <th>Ngày thanh toán</th>
                            <th>Dư nợ đầu kỳ</th>
                            <th>Gốc trả hàng tháng</th>
                            <th>Dư nợ cuối kỳ</th>
                            <th>Lãi suất/năm</th>
                            <th>Nợ lãi phải trả</th>
                            <th>Tổng nợ gốc và lãi phải trả tạm tính</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Nút điều hướng -->
        <div class="d-flex justify-content-between mb-4">
            <button type="button" class="btn btn-secondary btn-lg" onclick="window.location.href='index.html'">
                <i class="bi bi-arrow-left"></i> Quay lại
            </button>
            <button type="button" class="btn btn-warning btn-lg" onclick="resetForm()">
                <i class="bi bi-arrow-counterclockwise"></i> Bắt đầu lại
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script>
        // Hàm định dạng số với dấu chấm ngăn cách
        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Hàm chuyển đổi chuỗi số có dấu chấm thành số
        function parseFormattedNumber(str) {
            return parseInt(str.replace(/\./g, '')) || 0;
        }

        // Hàm chuyển đổi số thành định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // --- Hàm kiểm tra ngày nghỉ lễ ---
        function isHoliday(date) {
            // Danh sách ngày nghỉ lễ cố định (dd-mm)
            const holidays = [
                '01-01', // Tết Dương lịch
                '30-04', // Giải phóng miền Nam
                '01-05', // Quốc tế Lao động
                '02-09', // Quốc khánh
            ];
            const ddmm = (date.getDate().toString().padStart(2, '0')) + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
            // Chỉ kiểm tra ngày nghỉ lễ, KHÔNG kiểm tra cuối tuần
            if (holidays.includes(ddmm)) return true;
            return false;
        }
        // --- Hàm tìm ngày làm việc gần nhất sau ngày truyền vào (chỉ bỏ qua ngày nghỉ lễ) ---
        function getNextWorkingDay(date) {
            let d = new Date(date);
            while (isHoliday(d)) {
                d.setDate(d.getDate() + 1);
            }
            return d;
        }

        // Hàm tính lịch trả nợ
        function calculateSchedule() {
            const assetValue = parseFormattedNumber(document.getElementById('assetValue').value);
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount').value);
            const term = parseInt(document.getElementById('loanTerm').value);
            const fixedPackage = document.getElementById('fixedPackage').value;
            const afterFixedRate = parseFloat(document.getElementById('afterFixedRate').value);
            let graceMonths = 0;
            if (fixedPackage === 'young_1' || fixedPackage === 'young_2') {
                graceMonths = parseInt(document.getElementById('gracePeriod').value) || 60;
            }

            // Kiểm tra số tiền vay không được vượt quá giá trị tài sản
            if (assetValue > 0 && loanAmount > 0 && loanAmount > assetValue) {
                alert('Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!');
                return;
            }
            // Kiểm tra điều kiện gói và thời hạn vay
            if (!checkPackageTerm()) {
                return;
            }

            if (loanAmount > 0 && term > 0) {
                // Tính lãi suất cố định và thời gian ân hạn dựa trên gói đã chọn
                let fixedRate = 6.0;
                let secondFixedRate = null;
                let fixedMonths = 12;
                let secondFixedMonths = 0;

                if (fixedPackage === '12') {
                    fixedRate = 6.0;
                    fixedMonths = 12;
                } else if (fixedPackage === '18') {
                    fixedRate = 6.3;
                    fixedMonths = 18;
                } else if (fixedPackage === '24') {
                    fixedRate = 6.5;
                    fixedMonths = 24;
                } else if (fixedPackage === '36') {
                    fixedRate = 8.0;
                    fixedMonths = 36;
                } else if (fixedPackage === 'young_1') {
                    fixedRate = 5.5;
                    fixedMonths = 36;
                } else if (fixedPackage === 'young_2') {
                    fixedRate = 5.2;
                    secondFixedRate = 6.6;
                    fixedMonths = 12;
                    secondFixedMonths = 24;
                }

                const monthlyRate = fixedRate / 12 / 100;
                const secondMonthlyRate = secondFixedRate ? secondFixedRate / 12 / 100 : null;
                const afterMonthlyRate = afterFixedRate / 12 / 100;
                
                let remainingPrincipal = loanAmount;
                const scheduleBody = document.getElementById('scheduleBody');
                scheduleBody.innerHTML = '';

                const today = new Date();
                let openingPrincipal = loanAmount;
                for (let i = 1; i <= term; i++) {
                    // Xác định lãi suất áp dụng cho kỳ hiện tại
                    let currentRate, currentRateYear;
                    if (i <= fixedMonths) {
                        currentRate = monthlyRate;
                        currentRateYear = fixedRate;
                    } else if (secondFixedRate && i <= fixedMonths + secondFixedMonths) {
                        currentRate = secondMonthlyRate;
                        currentRateYear = secondFixedRate;
                    } else {
                        currentRate = afterMonthlyRate;
                        currentRateYear = afterFixedRate;
                    }

                    const interestPayment = openingPrincipal * currentRate;
                    // Tính gốc trả hàng tháng
                    let monthlyPrincipal = 0;
                    if (i > graceMonths) {
                        monthlyPrincipal = loanAmount / (term - graceMonths);
                    }
                    // Dư nợ cuối kỳ
                    let closingPrincipal = openingPrincipal - monthlyPrincipal;
                    if (closingPrincipal < 0) closingPrincipal = 0;
                    // Ngày thanh toán: ngày 5 mỗi tháng, nếu rơi vào ngày nghỉ lễ thì chuyển sang ngày làm việc gần nhất sau đó
                    const paymentDate = new Date(today.getFullYear(), today.getMonth() + i, 5);
                    const workingDate = getNextWorkingDay(paymentDate);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${i}</td>
                        <td>${workingDate.toLocaleDateString('vi-VN')}</td>
                        <td>${formatCurrency(Math.round(openingPrincipal))}</td>
                        <td>${formatCurrency(Math.round(monthlyPrincipal))}</td>
                        <td>${formatCurrency(Math.round(closingPrincipal))}</td>
                        <td>${currentRateYear.toFixed(2)}%</td>
                        <td>${formatCurrency(Math.round(interestPayment))}</td>
                        <td>${formatCurrency(Math.round(monthlyPrincipal + interestPayment))}</td>
                    `;
                    scheduleBody.appendChild(row);
                    // Sang kỳ tiếp theo, đầu kỳ = cuối kỳ kỳ trước
                    openingPrincipal = closingPrincipal;
                }

                document.getElementById('scheduleTable').style.display = 'block';
            }
        }

        // Hàm reset form
        function resetForm() {
            document.getElementById('assetValue').value = '';
            document.getElementById('loanAmount').value = '';
            document.getElementById('loanTerm').value = '';
            document.getElementById('fixedPackage').value = '12';
            document.getElementById('afterFixedRate').value = '9.0';
            document.getElementById('scheduleTable').style.display = 'none';

            // Reset trạng thái disable của các gói
            const fixedPackage = document.getElementById('fixedPackage');
            const options = fixedPackage.options;
            for (let i = 0; i < options.length; i++) {
                options[i].disabled = false;
            }
        }

        // Load dữ liệu từ index.html khi trang được tải
        window.addEventListener('load', function() {
            const loanData = JSON.parse(localStorage.getItem('loanData')) || {};
            
            if (loanData.assetValue && loanData.loanAmount && loanData.loanTerm) {
                document.getElementById('assetValue').value = formatNumber(loanData.assetValue);
                document.getElementById('loanAmount').value = formatNumber(loanData.loanAmount);
                document.getElementById('loanTerm').value = loanData.loanTerm;
                
                calculateSchedule();
            }
        });

        // Thêm định dạng số cho các input tiền
        ['assetValue', 'loanAmount'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\./g, '');
                if (value) {
                    if (value.length > 12) {
                        value = value.slice(0, 12);
                    }
                    value = parseInt(value);
                    e.target.value = formatNumber(value);
                }
            });
        });

        // Thêm event listener cho input số tiền vay
        document.getElementById('loanAmount').addEventListener('input', function(e) {
            const assetValue = parseFormattedNumber(document.getElementById('assetValue').value);
            const loanAmount = parseFormattedNumber(e.target.value);
            // Nếu chưa nhập giá trị tài sản thì không cảnh báo
            if (!assetValue || assetValue === 0) {
                e.target.classList.remove('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
                return;
            }
            if (loanAmount > assetValue) {
                e.target.classList.add('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback';
                    div.textContent = 'Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!';
                    e.target.parentNode.insertBefore(div, e.target.nextSibling);
                }
            } else {
                e.target.classList.remove('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
            }
        });

        // Thêm event listener cho input giá trị tài sản
        document.getElementById('assetValue').addEventListener('input', function(e) {
            const assetValue = parseFormattedNumber(e.target.value);
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount').value);
            // Nếu chưa nhập giá trị tài sản thì không cảnh báo
            if (!assetValue || assetValue === 0) {
                const loanAmountInput = document.getElementById('loanAmount');
                loanAmountInput.classList.remove('is-invalid');
                const feedback = loanAmountInput.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
                return;
            }
            if (loanAmount > assetValue) {
                const loanAmountInput = document.getElementById('loanAmount');
                loanAmountInput.classList.add('is-invalid');
                const feedback = loanAmountInput.nextElementSibling;
                if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback';
                    div.textContent = 'Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!';
                    loanAmountInput.parentNode.insertBefore(div, loanAmountInput.nextSibling);
                }
            } else {
                const loanAmountInput = document.getElementById('loanAmount');
                loanAmountInput.classList.remove('is-invalid');
                const feedback = loanAmountInput.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
            }
        });

        // --- Thêm xử lý cho phần chọn gói và ân hạn ---
        const fixedPackageSelect = document.getElementById('fixedPackage');
        const gracePeriodGroup = document.getElementById('gracePeriodGroup');
        const gracePeriodSelect = document.getElementById('gracePeriod');
        const loanTermInput = document.getElementById('loanTerm');
        const graceError = document.getElementById('graceError');
        // Thêm dòng báo lỗi cho các gói thường
        let packageError = document.getElementById('packageError');
        if (!packageError) {
            packageError = document.createElement('div');
            packageError.id = 'packageError';
            packageError.className = 'text-danger mt-2';
            packageError.style.display = 'none';
            fixedPackageSelect.parentNode.appendChild(packageError);
        }

        function checkPackageTerm() {
            const fixedPackage = fixedPackageSelect.value;
            const term = parseInt(loanTermInput.value) || 0;
            let valid = true;
            let errorMsg = '';
            // Nếu thời hạn vay chưa nhập hoặc = 0 thì không báo lỗi gì cả
            if (!loanTermInput.value || term === 0) {
                gracePeriodGroup.style.display = (fixedPackage === 'young_1' || fixedPackage === 'young_2') ? '' : 'none';
                graceError.style.display = 'none';
                packageError.textContent = '';
                packageError.style.display = 'none';
                return true;
            }
            // Gói ân hạn
            if (fixedPackage === 'young_1' || fixedPackage === 'young_2') {
                gracePeriodGroup.style.display = '';
                const graceMonths = parseInt(gracePeriodSelect.value);
                if (term > 0 && graceMonths > 0 && term < graceMonths) {
                    graceError.style.display = '';
                    valid = false;
                } else {
                    graceError.style.display = 'none';
                }
            } else {
                gracePeriodGroup.style.display = 'none';
                graceError.style.display = 'none';
                // Các gói thường: kiểm tra thời hạn vay >= số tháng của gói
                let minMonths = parseInt(fixedPackage);
                if (!isNaN(minMonths) && term > 0 && term < minMonths) {
                    errorMsg = `Thời hạn vay phải lớn hơn hoặc bằng số tháng của gói (${minMonths} tháng)!`;
                    valid = false;
                }
            }
            // Hiện hoặc ẩn lỗi cho gói thường
            if (errorMsg) {
                packageError.textContent = errorMsg;
                packageError.style.display = '';
            } else {
                packageError.textContent = '';
                packageError.style.display = 'none';
            }
            return valid && graceError.style.display === 'none';
        }

        fixedPackageSelect.addEventListener('change', checkPackageTerm);
        gracePeriodSelect.addEventListener('change', checkPackageTerm);
        loanTermInput.addEventListener('input', checkPackageTerm);
    </script>
</body>
</html> 