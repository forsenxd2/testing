<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch trả nợ chi tiết</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .step-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.95);
        }
        .step-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .hidden {
            display: none;
        }
        body {
            /* background-image: url('images/logo.png'); */ /* Đã xóa logo */
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: contain;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .container {
            position: relative;
            z-index: 1;
        }
        .menu-btn {
            box-shadow: 0 4px 16px rgba(34,139,34,0.12), 0 1.5px 4px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s, transform 0.2s, background 0.2s;
            cursor: pointer;
            font-size: 1.08rem;
            font-weight: bold;
            padding: 0.7rem 1.2rem;
            border-radius: 10px;
        }
        .menu-btn:hover, .menu-btn:focus {
            box-shadow: 0 8px 24px rgba(34,139,34,0.18), 0 2px 8px rgba(0,0,0,0.12);
            transform: translateY(-2px) scale(1.03);
            background: #e6f4ea !important;
        }
        .blink-cursor {
            animation: blink-cursor 1s steps(2, start) infinite;
            color: #228B22;
            font-size: 1.2em;
            transform: scale(3);
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes blink-cursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
        .input-million-group {
            display: flex;
            align-items: center;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: #fff;
            overflow: hidden;
            width: fit-content;
            max-width: none;
            min-width: 0;
            height: 40px;
        }
        .input-million-group input,
        .input-million {
            min-width: 4ch;
            width: auto;
            border: none;
            box-shadow: none;
            outline: none;
            border-radius: 0;
            background: transparent;
            flex: 1 1 0;
            text-align: right;
            padding: 6px 0 6px 8px;
            font-size: 1rem;
            height: 40px;
            line-height: 40px;
            display: block;
        }
        .input-million-suffix {
            background: transparent;
            border: none;
            padding: 0 8px 0 2px;
            color: #212529;
            font-size: 1rem;
            font-weight: 400;
            line-height: 40px;
            height: 40px;
            display: flex;
            align-items: center;
        }
        @media print {
            body * {
                visibility: hidden !important;
            }
            #scheduleTable, #scheduleTable * {
                visibility: visible !important;
            }
            #scheduleTable {
                position: absolute;
                left: 0;
                top: 0;
                width: 100vw;
                margin: 0;
                padding: 0;
                background: #fff !important;
            }
            .step-container, .step-header, .table-responsive, table {
                background: #fff !important;
                color: #000 !important;
            }
            .table th, .table td {
                background: #fff !important;
                color: #000 !important;
                border: 1px solid #333 !important;
            }
            .container, .step-container {
                box-shadow: none !important;
            }
            .d-flex, .btn, .menu-btn, .input-million-group, .input-million-suffix, .input-million, .form-label, .form-control, .form-select {
                box-shadow: none !important;
            }
            /* Ẩn các nút, chỉ in bảng */
            .btn, .menu-btn, .input-million-group, .input-million-suffix, .input-million, .form-label, .form-control, .form-select, #inputForm, .d-flex.flex-column, .d-flex.gap-2, .d-flex.justify-content-between {
                display: none !important;
            }
            h1, .step-header h3 {
                text-align: center !important;
                color: #228B22 !important;
                font-size: 2rem !important;
                margin-bottom: 1rem !important;
            }
            #scheduleTable .table-responsive {
                overflow-x: visible !important;
            }
            #scheduleTable table {
                min-width: 1200px !important;
                width: 100% !important;
                font-size: 12px !important;
                table-layout: auto !important;
            }
            .table th, .table td {
                white-space: nowrap !important;
            }
        }
        .menu-responsive {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
        }
        .menu-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .menu-blanca {
            display: flex;
            flex-direction: column;
            align-items: end;
        }
        @media (max-width: 767.98px) {
            .menu-responsive {
                flex-direction: column;
                gap: 10px;
            }
            .menu-group, .menu-blanca {
                align-items: stretch !important;
                width: 100%;
            }
            .menu-blanca {
                margin-top: 10px;
                align-items: stretch !important;
            }
            .menu-btn {
                min-width: unset !important;
                width: 100%;
                font-size: 1.08rem;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex flex-column align-items-start mb-3 gap-2">
            <div class="menu-responsive w-100">
                <div class="menu-group">
            <button type="button" class="btn btn-sm fw-bold menu-btn"
                style="background-color: #ffe066; color: #228B22; min-width: 260px; border: none;"
                onclick="window.location.href='projects.html'">
                <img src="images/mouse.png" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
                DANH MỤC CÁC DỰ ÁN LIÊN KẾT VỚI VCB THỦ THIÊM
            </button>
            <button type="button" class="btn btn-sm fw-bold menu-btn"
                style="background-color: #ffe066; color: #228B22; min-width: 260px; border: none;"
                onclick="window.location.href='laisuat.html'">
                <img src="images/mouse.png" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
                CÁC GÓI LÃI SUẤT CHO VAY KHCN HIỆN HÀNH
            </button>
            <button type="button" class="btn btn-sm fw-bold menu-btn"
                style="background-color: #ffe066; color: #228B22; min-width: 260px; border: none;"
                onclick="window.location.href='hosovay.html'">
                <img src="images/mouse.png" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
                DANH MỤC HỒ SƠ VAY VỐN KHÁCH HÀNG CUNG CẤP
            </button>
            <button type="button" class="btn btn-sm fw-bold menu-btn"
                style="background-color: #ffe066; color: #228B22; min-width: 260px; border: none;"
                onclick="window.location.href='bodieukien.html'">
                <img src="images/mouse.png" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
                BỘ ĐIỀU KIỆN SẢN PHẨM NHÀ DỰ ÁN
            </button>
            <button type="button" class="btn btn-sm fw-bold menu-btn"
                style="background-color: #ffe066; color: #228B22; min-width: 260px; border: none;"
                onclick="window.location.href='bangchao.html'">
                <img src="images/mouse.png" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
                BẢNG CHÀO
            </button>
                </div>
                <div class="menu-blanca">
                    <button type="button" class="btn btn-sm fw-bold menu-btn"
                        style="background-color: #228B22; color: white; min-width: 260px; border: none;"
                        onclick="window.location.href='blanca.html'">
                        <img src="images/mouse.png" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
                        DỰ ÁN BLANCA CITY
                    </button>
                </div>
            </div>
        </div>
        <h1 class="text-center mb-4">Lịch trả nợ chi tiết</h1>

        <!-- Form nhập liệu -->
        <div class="step-container" id="inputForm">
            <div class="step-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Thông tin khoản vay</h3>
                <button type="button" class="btn btn-secondary btn-sm fw-bold" onclick="window.location.href='index.html'">
                    <i class="bi bi-arrow-left"></i> Quay lại
                </button>
            </div>
            <form id="loanForm">
                <div class="mb-3">
                    <label for="assetValue_million" class="form-label">Giá trị tài sản mua/Tài sản bảo đảm (VND)</label>
                    <div class="input-million-group">
                        <input type="text" id="assetValue_million" maxlength="8" size="4" autocomplete="off" class="input-million">
                        <span class="input-million-suffix">.000.000</span>
                    </div>
                    <span id="assetValue_display" class="ms-2 text-success"></span>
                </div>
                <div class="mb-3">
                    <label for="loanAmount_million" class="form-label">Số tiền vay (VND)</label>
                    <div class="input-million-group">
                        <input type="text" id="loanAmount_million" maxlength="8" size="4" autocomplete="off" class="input-million">
                        <span class="input-million-suffix">.000.000</span>
                    </div>
                    <span id="loanAmount_display" class="ms-2 text-success"></span>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold" style="font-size:1.08rem; color:#228B22;">Mục đích vay</label>
                    <div id="loanPurposeGroup">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="loanPurpose" id="purpose_bds" value="bds" checked>
                            <label class="form-check-label" for="purpose_bds">Mua BĐS ở TP.HCM/Hà Nội</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="loanPurpose" id="purpose_land" value="land">
                            <label class="form-check-label" for="purpose_land">Mua đất ở</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="loanPurpose" id="purpose_young" value="young">
                            <label class="form-check-label" for="purpose_young">Gói người trẻ</label>
                        </div>
                    </div>
                </div>
                <div class="mb-3" id="houseValueBucketGroup">
                    <label class="form-label fw-bold" style="font-size:1.08rem; color:#228B22;">Giá trị nhà ở</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="houseBucket" id="bucket_low" value="low" checked>
                        <label class="form-check-label" for="bucket_low">≤ 5 tỷ</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="houseBucket" id="bucket_high" value="high">
                        <label class="form-check-label" for="bucket_high">> 5 tỷ</label>
                    </div>
                </div>
                <div id="fixedPackageHighlight" class="mb-3 p-3 border border-primary rounded" style="background-color: #fffacd;">
                    <label for="fixedPackage" class="form-label fw-bold" style="font-size:1.15rem; color:#0d6efd;">
                        <i class="bi bi-star-fill"></i> Chọn gói cố định lãi suất
                    </label>
                    <select class="form-select" id="fixedPackage">
                        <!-- Options sẽ được cập nhật động bằng JS -->
                    </select>
                    <div id="gracePeriodGroup" class="mt-3">
                        <label for="gracePeriod" class="form-label">Chọn thời gian ân hạn gốc (tháng)</label>
                        <select class="form-select" id="gracePeriod">
                            <option value="0">0 tháng (không ân hạn)</option>
                            <option value="12">12 tháng (1 năm)</option>
                            <option value="24">24 tháng (2 năm)</option>
                            <option value="36">36 tháng (3 năm)</option>
                            <option value="48">48 tháng (4 năm)</option>
                            <option value="60">60 tháng (5 năm)</option>
                        </select>
                    </div>
                    <div id="graceError" class="text-danger mt-2" style="display:none;">Thời hạn vay phải lớn hơn hoặc bằng thời gian ân hạn gốc!</div>
                </div>
                <div class="mb-3" id="afterFixedRateGroup">
                    <label for="afterFixedRate" class="form-label" id="afterFixedRateLabel">Lãi suất tiết kiệm 12 tháng hiện tại (%/năm)</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="afterFixedRate" min="0" step="0.01" value="5.5">
                        <span class="input-group-text" id="afterFixedRateNote">+ 3,5%/năm = lãi suất sau ưu đãi</span>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Thời hạn vay (tháng)</label>
                    <input type="number" class="form-control" id="loanTerm" required min="1">
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-primary" onclick="calculateSchedule()">Xem lịch trả nợ</button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-danger">
                            <i class="bi bi-file-earmark-pdf"></i> Tải file PDF
                        </button>
                        <button type="button" class="btn btn-success">
                            <i class="bi bi-download"></i> Tải file Excel
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Bảng lịch trả nợ -->
        <div class="step-container" id="scheduleTable" style="display: none;">
            <div class="step-header">
                <h3>Chi tiết lịch trả nợ(tạm tính)</h3>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Kỳ</th>
                            <th>Ngày thanh toán</th>
                            <th>Dư nợ đầu kỳ</th>
                            <th>Gốc trả hàng tháng</th>
                            <th>Dư nợ cuối kỳ</th>
                            <th>Lãi suất/năm</th>
                            <th>Nợ lãi phải trả</th>
                            <th>Tổng nợ gốc và lãi phải trả tạm tính</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://unpkg.com/@jsreport/jsreport-pdf-font-dejavu@1.0.0/dist/jsreport-pdf-font-dejavu.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script>
        // Hàm định dạng số với dấu chấm ngăn cách
        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Hàm chuyển đổi chuỗi số có dấu chấm thành số
        function parseFormattedNumber(str) {
            return parseInt(str.replace(/\./g, '')) || 0;
        }

        // Hàm chuyển đổi số thành định dạng tiền tệ
        function formatCurrency(amount) {
            if (!amount || isNaN(amount)) return '0 VND';
            return amount.toLocaleString('vi-VN') + ' VND';
        }

        // Hàm format tiền
        function formatMoney(million) {
            if (!million || isNaN(million)) return '';
            let num = parseInt(million);
            if (num >= 1000) {
                let ty = Math.floor(num / 1000);
                let trieu = num % 1000;
                if (trieu === 0) return ty + ' tỷ đồng';
                return ty + ' tỷ ' + trieu + ' triệu đồng';
            }
            return num + ' triệu đồng';
        }

        // Gán sự kiện cho các input triệu
        function setupMillionInput(inputId, displayId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            input.addEventListener('input', function() {
                let value = input.value.replace(/\D/g, '').substring(0,8);
                input.value = value ? formatNumber(value) : '';
                display.textContent = formatMoney(value);
            });
            input.addEventListener('blur', function() {
                let value = input.value.replace(/\D/g, '').substring(0,8);
                input.value = value ? formatNumber(value) : '';
                display.textContent = formatMoney(value);
            });
            // Hiển thị mặc định
            display.textContent = '';
        }
        setupMillionInput('assetValue_million', 'assetValue_display');
        setupMillionInput('loanAmount_million', 'loanAmount_display');

        // Hàm kiểm tra ngày nghỉ lễ
        function isHoliday(date) {
            // Danh sách ngày nghỉ lễ cố định (dd-mm)
            const holidays = [
                '01-01', // Tết Dương lịch
                '30-04', // Giải phóng miền Nam
                '01-05', // Quốc tế Lao động
                '02-09', // Quốc khánh
            ];
            const ddmm = (date.getDate().toString().padStart(2, '0')) + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
            // Chỉ kiểm tra ngày nghỉ lễ, KHÔNG kiểm tra cuối tuần
            return holidays.includes(ddmm);
        }
        // Hàm tìm ngày làm việc gần nhất sau ngày truyền vào (chỉ bỏ qua ngày nghỉ lễ)
        function getNextWorkingDay(date) {
            let d = new Date(date);
            while (isHoliday(d)) {
                d.setDate(d.getDate() + 1);
            }
            return d;
        }

        // Hàm kiểm tra và dời ngày nếu rơi vào thứ 7/CN
        function adjustToNextMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            if (day === 6) { // Thứ 7
                d.setDate(d.getDate() + 2);
            } else if (day === 0) { // Chủ nhật
                d.setDate(d.getDate() + 1);
            }
            return d;
        }

        // Hàm tính lịch trả nợ
        function calculateSchedule() {
            const assetValue = parseFormattedNumber(document.getElementById('assetValue_million').value) * 1000000;
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount_million').value) * 1000000;
            const term = parseInt(document.getElementById('loanTerm').value);
            const fixedPackage = document.getElementById('fixedPackage').value;
            let afterFixedRate = parseFloat(document.getElementById('afterFixedRate').value);
            // Lấy thời gian ân hạn cho tất cả các gói
            let graceMonths = parseInt(document.getElementById('gracePeriod').value, 10) || 0;

            // Nếu là gói phổ thông (6/12/18/24/36) thì lãi suất sau ưu đãi = LSTK 12T + 3,5%
            if (["6","12","18","24","36"].includes(fixedPackage)) {
                afterFixedRate = afterFixedRate + 3.5;
            }

            // Kiểm tra số tiền vay không được vượt quá giá trị tài sản
            if (assetValue > 0 && loanAmount > 0 && loanAmount > assetValue) {
                alert('Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!');
                return;
            }
            // Kiểm tra điều kiện gói và thời hạn vay
            if (!checkPackageTerm()) {
                return;
            }

            if (loanAmount > 0 && term > 0) {
                // Tính lãi suất cố định và thời gian ân hạn dựa trên gói đã chọn
                let fixedRate = 6.0;
                let secondFixedRate = null;
                let fixedMonths = 12;
                let secondFixedMonths = 0;

                const purpose = document.querySelector('input[name="loanPurpose"]:checked').value;
                const bucket = document.querySelector('input[name=\"houseBucket\"]:checked')?.value || 'low';
                const fixedPackageValue = fixedPackage;

                // Gói đặc biệt: người trẻ
                if (fixedPackageValue === 'young_1') {
                    fixedRate = 5.8; // cập nhật theo ảnh
                    fixedMonths = 36;
                } else if (fixedPackageValue === 'young_2') {
                    fixedRate = 5.8; // năm 1
                    fixedMonths = 12; // Năm 1
                    secondFixedRate = null; // Năm 2&3 dùng thả nổi = LSTK + 2%
                    secondFixedMonths = 24;
                } else {
                    // Gói cố định theo mục đích
                    let list = [];
                    if (purpose === 'bds') {
                        list = fixedPackages.bds[bucket] || [];
                    } else if (purpose === 'land') {
                        list = fixedPackages.land;
                    }
                    const pkg = list.find(p => p.value === fixedPackageValue);
                    if (pkg) {
                        fixedRate = pkg.rate;
                        fixedMonths = pkg.months;
                        if (pkg.secondRate && pkg.secondMonths) {
                            secondFixedRate = pkg.secondRate;
                            secondFixedMonths = pkg.secondMonths;
                        }
                    }
                }

                const monthlyRate = fixedRate / 12 / 100;
                let secondMonthlyRate = null;
                if (fixedPackageValue === 'young_2') {
                    // LSTK 12T + 2% cho năm 2 & 3
                    secondMonthlyRate = (afterFixedRate + 2) / 12 / 100;
                } else if (secondFixedRate) {
                    secondMonthlyRate = secondFixedRate / 12 / 100;
                }
                const afterMonthlyRate = (fixedPackageValue === 'young_2') ? (afterFixedRate + 3) / 12 / 100 : afterFixedRate / 12 / 100;
                
                let remainingPrincipal = loanAmount;
                const scheduleBody = document.getElementById('scheduleBody');
                scheduleBody.innerHTML = '';

                const today = new Date();
                let openingPrincipal = loanAmount;
                for (let i = 1; i <= term; i++) {
                    // Xác định lãi suất áp dụng cho kỳ hiện tại
                    let currentRate, currentRateYear;
                    if (secondFixedRate !== null) {
                        if (i <= fixedMonths) {
                            currentRate = monthlyRate;
                            currentRateYear = fixedRate;
                        } else if (i <= fixedMonths + secondFixedMonths) {
                            currentRate = secondMonthlyRate;
                            currentRateYear = (fixedPackageValue === 'young_2') ? (afterFixedRate + 2) : secondFixedRate;
                        } else {
                            currentRate = afterMonthlyRate;
                            currentRateYear = (fixedPackageValue === 'young_2') ? (afterFixedRate + 3) : afterFixedRate;
                        }
                    } else {
                        if (i <= fixedMonths) {
                            currentRate = monthlyRate;
                            currentRateYear = fixedRate;
                        } else {
                            currentRate = afterMonthlyRate;
                            currentRateYear = afterFixedRate;
                        }
                    }

                    // Tính gốc trả hàng tháng
                    let monthlyPrincipal = 0;
                    if (graceMonths === 0 || i > graceMonths) {
                        monthlyPrincipal = loanAmount / (term - graceMonths);
                        // Đảm bảo không trả quá số dư nợ còn lại
                        if (monthlyPrincipal > openingPrincipal) {
                            monthlyPrincipal = openingPrincipal;
                        }
                    }
                    // Dư nợ cuối kỳ
                    let closingPrincipal = openingPrincipal - monthlyPrincipal;
                    if (closingPrincipal < 0) closingPrincipal = 0;
                    // Ngày thanh toán: ngày 5 mỗi tháng, nếu rơi vào ngày nghỉ lễ thì chuyển sang ngày làm việc gần nhất sau đó
                    const paymentDate = new Date(today.getFullYear(), today.getMonth() + i, 5);
                    let workingDate = getNextWorkingDay(paymentDate);
                    workingDate = adjustToNextMonday(workingDate);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${i}</td>
                        <td>${workingDate.toLocaleDateString('vi-VN')}</td>
                        <td>${formatCurrency(Math.round(openingPrincipal))}</td>
                        <td>${formatCurrency(Math.round(monthlyPrincipal))}</td>
                        <td>${formatCurrency(Math.round(closingPrincipal))}</td>
                        <td>${currentRateYear.toFixed(2)}%</td>
                        <td>${formatCurrency(Math.round(openingPrincipal * currentRate))}</td>
                        <td>${formatCurrency(Math.round(monthlyPrincipal + openingPrincipal * currentRate))}</td>
                    `;
                    scheduleBody.appendChild(row);
                    // Sang kỳ tiếp theo, đầu kỳ = cuối kỳ kỳ trước
                    openingPrincipal = closingPrincipal;
                }

                document.getElementById('scheduleTable').style.display = 'block';
            }
        }

        // Hàm reset form
        function resetForm() {
            document.getElementById('assetValue_million').value = '';
            document.getElementById('loanAmount_million').value = '';
            document.getElementById('loanTerm').value = '';
            document.getElementById('fixedPackage').value = '12';
            document.getElementById('afterFixedRate').value = '9.0';
            document.getElementById('scheduleTable').style.display = 'none';

            // Reset trạng thái disable của các gói
            const fixedPackage = document.getElementById('fixedPackage');
            const options = fixedPackage.options;
            for (let i = 0; i < options.length; i++) {
                options[i].disabled = false;
            }
        }

        // Load dữ liệu từ index.html khi trang được tải
        window.addEventListener('load', function() {
            const loanData = JSON.parse(localStorage.getItem('loanData')) || {};
            if (loanData.assetValue) {
                const assetValue = Math.floor(loanData.assetValue / 1000000) || '';
                document.getElementById('assetValue_million').value = assetValue ? formatNumber(assetValue) : '';
                document.getElementById('assetValue_display').textContent = formatMoney(assetValue);
            }
            if (loanData.loanAmount) {
                const loanAmount = Math.floor(loanData.loanAmount / 1000000) || '';
                document.getElementById('loanAmount_million').value = loanAmount ? formatNumber(loanAmount) : '';
                document.getElementById('loanAmount_display').textContent = formatMoney(loanAmount);
            }
            if (loanData.loanTerm) {
                document.getElementById('loanTerm').value = loanData.loanTerm;
            }
            
            calculateSchedule();
        });

        // Thêm định dạng số cho các input tiền
        ['assetValue_million', 'loanAmount_million'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\./g, '');
                if (value) {
                    if (value.length > 12) {
                        value = value.slice(0, 12);
                    }
                    value = parseInt(value);
                    e.target.value = formatNumber(value);
                }
            });
        });

        // Thêm event listener cho input số tiền vay
        document.getElementById('loanAmount_million').addEventListener('input', function(e) {
            const assetValue = parseFormattedNumber(document.getElementById('assetValue_million').value) * 1000000;
            const loanAmount = parseFormattedNumber(e.target.value) * 1000000;
            // Nếu chưa nhập giá trị tài sản thì không cảnh báo
            if (!assetValue || assetValue === 0) {
                e.target.classList.remove('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
                return;
            }
            if (loanAmount > assetValue) {
                e.target.classList.add('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback';
                    div.textContent = 'Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!';
                    e.target.parentNode.insertBefore(div, e.target.nextSibling);
                }
            } else {
                e.target.classList.remove('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
            }
        });

        // Thêm event listener cho input giá trị tài sản
        document.getElementById('assetValue_million').addEventListener('input', function(e) {
            const assetValue = parseFormattedNumber(e.target.value) * 1000000;
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount_million').value) * 1000000;
            // Nếu chưa nhập giá trị tài sản thì không cảnh báo
            if (!assetValue || assetValue === 0) {
                const loanAmountInput = document.getElementById('loanAmount_million');
                loanAmountInput.classList.remove('is-invalid');
                const feedback = loanAmountInput.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
                return;
            }
            if (loanAmount > assetValue) {
                const loanAmountInput = document.getElementById('loanAmount_million');
                loanAmountInput.classList.add('is-invalid');
                const feedback = loanAmountInput.nextElementSibling;
                if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback';
                    div.textContent = 'Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!';
                    loanAmountInput.parentNode.insertBefore(div, loanAmountInput.nextSibling);
                }
            } else {
                const loanAmountInput = document.getElementById('loanAmount_million');
                loanAmountInput.classList.remove('is-invalid');
                const feedback = loanAmountInput.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
            }
        });

        // --- Thêm xử lý cho phần chọn gói và ân hạn ---
        const fixedPackageSelect = document.getElementById('fixedPackage');
        const gracePeriodGroup = document.getElementById('gracePeriodGroup');
        const gracePeriodSelect = document.getElementById('gracePeriod');
        const loanTermInput = document.getElementById('loanTerm');
        const graceError = document.getElementById('graceError');
        // Thêm dòng báo lỗi cho các gói thường
        let packageError = document.getElementById('packageError');
        if (!packageError) {
            packageError = document.createElement('div');
            packageError.id = 'packageError';
            packageError.className = 'text-danger mt-2';
            packageError.style.display = 'none';
            fixedPackageSelect.parentNode.appendChild(packageError);
        }

        function checkPackageTerm() {
            const fixedPackage = fixedPackageSelect.value;
            const term = parseInt(loanTermInput.value) || 0;
            let valid = true;
            let errorMsg = '';
            
            // Hiển thị tùy chọn ân hạn cho tất cả các gói
            gracePeriodGroup.style.display = '';
            
            // Nếu thời hạn vay chưa nhập hoặc = 0 thì không báo lỗi gì cả
            if (!loanTermInput.value || term === 0) {
                graceError.style.display = 'none';
                packageError.textContent = '';
                packageError.style.display = 'none';
                return true;
            }
            
            // Kiểm tra ân hạn cho tất cả các gói
            const graceMonths = parseInt(gracePeriodSelect.value, 10);
                if (term > 0 && graceMonths > 0 && term < graceMonths) {
                    graceError.style.display = '';
                    valid = false;
                } else {
                    graceError.style.display = 'none';
                }
            
            // Kiểm tra thời hạn vay với số tháng của gói
                let minMonths = parseInt(fixedPackage);
            // Không còn gói tiêu dùng
                if (!isNaN(minMonths) && term > 0 && term < minMonths) {
                    errorMsg = `Thời hạn vay phải lớn hơn hoặc bằng số tháng của gói (${minMonths} tháng)!`;
                    valid = false;
                }
            
            // Hiện hoặc ẩn lỗi cho gói thường
            if (errorMsg) {
                packageError.textContent = errorMsg;
                packageError.style.display = '';
            } else {
                packageError.textContent = '';
                packageError.style.display = 'none';
            }
            return valid && graceError.style.display === 'none';
        }

        fixedPackageSelect.addEventListener('change', checkPackageTerm);
        gracePeriodSelect.addEventListener('change', checkPackageTerm);
        loanTermInput.addEventListener('input', checkPackageTerm);

        function updateAfterFixedRateLabel() {
            const fixedPackage = document.getElementById('fixedPackage').value;
            const afterFixedRateLabel = document.getElementById('afterFixedRateLabel');
            const afterFixedRateNote = document.getElementById('afterFixedRateNote');
            // Gói phổ thông: 6, 12, 18, 24, 36
            if (["6","12","18","24","36"].includes(fixedPackage)) {
                afterFixedRateLabel.textContent = 'Lãi suất tiết kiệm 12 tháng hiện tại (%/năm)';
                afterFixedRateNote.textContent = '+ 3,5%/năm = lãi suất sau ưu đãi';
            } else {
                afterFixedRateLabel.textContent = 'Lãi suất sau thời gian ưu đãi tạm tính (%/năm)';
                afterFixedRateNote.textContent = '';
            }
        }
        document.getElementById('fixedPackage').addEventListener('change', updateAfterFixedRateLabel);
        document.addEventListener('DOMContentLoaded', updateAfterFixedRateLabel);

        function downloadExcel() {
            // 1. Lấy thông tin khoản vay
            const assetValue = parseFormattedNumber(document.getElementById('assetValue_million').value) * 1000000;
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount_million').value) * 1000000;
            const term = parseInt(document.getElementById('loanTerm').value);
            const fixedPackage = document.getElementById('fixedPackage');
            const fixedPackageText = fixedPackage.options[fixedPackage.selectedIndex].text;
            const afterFixedRateRaw = parseFloat(document.getElementById('afterFixedRate').value);
            // Lấy thời gian ân hạn cho tất cả các gói
            let graceMonths = parseInt(document.getElementById('gracePeriod').value, 10) || 0;
            let graceText = graceMonths > 0 ? graceMonths + ' tháng' : '';
            // Ngày trả nợ đầu tiên
            const today = new Date();
            const firstPayment = new Date(today.getFullYear(), today.getMonth() + 1, 5);
            // 0. Thêm dòng tiêu đề lớn
            const titleRow = ['BẢNG LÃI SUẤT TẠM TÍNH'];
            // Lấy đúng lãi suất ưu đãi
            let fixedRateDisplay = '';
            const purpose = document.querySelector('input[name="loanPurpose"]:checked').value;
            if (["6","12","18","24","36"].includes(fixedPackage.value)) {
                // Lấy đúng rate theo mục đích & bucket nếu có
                const purpose = document.querySelector('input[name="loanPurpose"]:checked').value;
                let pkg = null;
                if (purpose === 'bds') {
                    const bucket = document.querySelector('input[name=\"houseBucket\"]:checked')?.value || 'low';
                    pkg = (fixedPackages.bds[bucket] || []).find(p => p.value === fixedPackage.value);
                } else if (purpose === 'land') {
                    pkg = fixedPackages.land.find(p => p.value === fixedPackage.value);
                } else {
                    pkg = null;
                }
                fixedRateDisplay = pkg ? (pkg.secondRate ? (pkg.months + 'm ' + pkg.rate.toFixed(2) + '%, ' + pkg.secondMonths + 'm ' + pkg.secondRate.toFixed(2) + '%') : (pkg.rate.toFixed(2) + '%')) : '';
            } else if (fixedPackage.value === 'young_1') {
                fixedRateDisplay = '5.80%';
            } else if (fixedPackage.value === 'young_2') {
                fixedRateDisplay = '5.80% (năm 1)';
            }
            // 2. Tạo dữ liệu phần tóm tắt
            const summary = [
                ['SỐ TIỀN VAY', loanAmount ? formatNumber(loanAmount) : ''],
                ['THỜI GIAN VAY', term ? term : ''],
                ['LÃI SUẤT ƯU ĐÃI', fixedRateDisplay],
                ['Thời gian ưu đãi', fixedPackage.value === 'young_2' ? 'Năm 1: 5,8%/năm; Năm 2&3: LSTK 12T + 2%/năm' : (fixedPackage.value === 'young_1' ? '36 tháng (5,8%)' : (fixedPackage.value + ' tháng'))],
                ['Lãi suất thả nổi', (["12","18","24","36"].includes(fixedPackage.value) ? (afterFixedRateRaw + 3.5).toFixed(2) : afterFixedRateRaw.toFixed(2)) + '%'],
                ['Ngày giải ngân dự kiến', today.toLocaleDateString('vi-VN')],
                ['Ngày trả nợ đầu tiên', firstPayment.toLocaleDateString('vi-VN')],
            ];
            if (graceText) summary.push(['Thời gian ân hạn gốc', graceText]);
            // 3. Lấy dữ liệu bảng lịch trả nợ
            const headerCells = document.querySelectorAll('#scheduleTable thead tr th');
            const headers = Array.from(headerCells).map(cell => cell.textContent.trim());
            const rows = document.querySelectorAll('#scheduleTable tbody tr');
            const scheduleData = [headers];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => cell.textContent.trim());
                scheduleData.push(rowData);
            });
            // 4. Gộp dữ liệu vào 1 sheet
            let ws_data = [];
            ws_data.push(titleRow);
            ws_data.push([]); // dòng trống
            summary.forEach(row => ws_data.push(row));
            ws_data.push([]); // dòng trống
            scheduleData.forEach(row => ws_data.push(row));
            // 5. Tạo workbook và xuất file
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            // Merge ô cho dòng tiêu đề lớn
            ws['!merges'] = ws['!merges'] || [];
            ws['!merges'].push({s: {r:0, c:0}, e: {r:0, c:headers.length-1}});
            // Định dạng font đậm, lớn, căn giữa, wrap text cho dòng đầu
            ws['A1'].s = {
                font: { bold: true, sz: 16 },
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true }
            };
            // Định dạng phần tóm tắt: căn trái, wrap text
            for (let i = 2; i < 2 + summary.length; i++) {
                const cellA = ws[`A${i+1}`];
                const cellB = ws[`B${i+1}`];
                if (cellA) cellA.s = { font: { bold: true }, alignment: { horizontal: 'left', wrapText: true } };
                if (cellB) cellB.s = { alignment: { horizontal: 'left', wrapText: true } };
            }
            // Định dạng header bảng chi tiết: đậm, căn giữa, wrap text
            const headerRowIdx = 2 + summary.length + 2;
            for (let c = 0; c < headers.length; c++) {
                const col = String.fromCharCode(65 + c);
                const cell = ws[`${col}${headerRowIdx+1}`];
                if (cell) cell.s = { font: { bold: true }, alignment: { horizontal: 'center', wrapText: true } };
            }
            // Định dạng dữ liệu bảng chi tiết
            for (let r = headerRowIdx + 1; r < ws_data.length; r++) {
                for (let c = 0; c < headers.length; c++) {
                    const col = String.fromCharCode(65 + c);
                    const cell = ws[`${col}${r+1}`];
                    if (cell) {
                        // Cột số: căn phải, wrap text; Cột ngày/kỳ: căn giữa
                        if (c === 0 || c === 1) {
                            cell.s = { alignment: { horizontal: 'center', wrapText: true } };
                        } else {
                            cell.s = { alignment: { horizontal: 'right', wrapText: true } };
                        }
                    }
                }
            }
            // Set width cho các cột hợp lý hơn
            ws['!cols'] = headers.map((h, idx) => {
                if (idx === 0) return { wch: 5 };
                if (idx === 1) return { wch: 13 };
                if (h.includes('Dư nợ')) return { wch: 18 };
                if (h.includes('Gốc')) return { wch: 15 };
                if (h.includes('Lãi')) return { wch: 15 };
                if (h.includes('Tổng')) return { wch: 22 };
                return { wch: 12 };
            });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'LichTraNo');
            XLSX.writeFile(wb, 'lich_tra_no.xlsx');
        }

        function downloadPDF() {
            // Lấy thông tin tóm tắt
            const assetValue = parseFormattedNumber(document.getElementById('assetValue_million').value) * 1000000;
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount_million').value) * 1000000;
            const term = parseInt(document.getElementById('loanTerm').value);
            const fixedPackage = document.getElementById('fixedPackage');
            const fixedPackageText = fixedPackage.options[fixedPackage.selectedIndex].text;
            const afterFixedRateRaw = parseFloat(document.getElementById('afterFixedRate').value);
            // Lấy thời gian ân hạn cho tất cả các gói
            let graceMonths = parseInt(document.getElementById('gracePeriod').value, 10) || 0;
            let graceText = graceMonths > 0 ? graceMonths + ' tháng' : '';
            const today = new Date();
            const firstPayment = new Date(today.getFullYear(), today.getMonth() + 1, 5);
            // Tóm tắt
            // Lấy lãi suất ưu đãi chuẩn xác
            let fixedRateDisplay = '';
            if (["6","12","18","24","36"].includes(fixedPackage.value)) {
                // Lấy đúng rate từ object
                const purpose = document.querySelector('input[name="loanPurpose"]:checked').value;
                let pkg = null;
                if (purpose === 'bds') {
                    const bucket = document.querySelector('input[name=\"houseBucket\"]:checked')?.value || 'low';
                    pkg = (fixedPackages.bds[bucket] || []).find(p => p.value === fixedPackage.value);
                } else if (purpose === 'land') {
                    pkg = fixedPackages.land.find(p => p.value === fixedPackage.value);
                }
                fixedRateDisplay = pkg ? (pkg.secondRate ? (pkg.months + 'm ' + pkg.rate.toFixed(2) + '%, ' + pkg.secondMonths + 'm ' + pkg.secondRate.toFixed(2) + '%') : (pkg.rate.toFixed(2) + '%')) : '';
            } else if (fixedPackage.value === 'young_1') {
                fixedRateDisplay = '5.80%';
            } else if (fixedPackage.value === 'young_2') {
                fixedRateDisplay = '5.80% (năm 1)';
            }
            const summary = [
                ['SỐ TIỀN VAY', loanAmount ? formatNumber(loanAmount) : ''],
                ['THỜI GIAN VAY', term ? term : ''],
                ['LÃI SUẤT ƯU ĐÃI', fixedRateDisplay],
                ['Thời gian ưu đãi', fixedPackage.value === 'young_2' ? 'Năm 1: 5,8%/năm; Năm 2&3: LSTK 12T + 2%/năm' : (fixedPackage.value === 'young_1' ? '36 tháng (5,8%)' : (fixedPackage.value + ' tháng'))],
                ['Lãi suất thả nổi', (["12","18","24","36"].includes(fixedPackage.value) ? (afterFixedRateRaw + 3.5).toFixed(2) : afterFixedRateRaw.toFixed(2)) + '%'],
                ['Ngày giải ngân dự kiến', today.toLocaleDateString('vi-VN')],
                ['Ngày trả nợ đầu tiên', firstPayment.toLocaleDateString('vi-VN')],
            ];
            if (graceText) summary.push(['Thời gian ân hạn gốc', graceText]);
            // Lấy bảng lịch trả nợ
            const headerCells = document.querySelectorAll('#scheduleTable thead tr th');
            const headers = Array.from(headerCells).map(cell => cell.textContent.trim());
            const rows = document.querySelectorAll('#scheduleTable tbody tr');
            const data = [];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => cell.textContent.trim());
                data.push(rowData);
            });
            // Tạo bảng pdfmake
            const tableBody = [headers];
            data.forEach(row => tableBody.push(row));
            // Định nghĩa PDF
            const docDefinition = {
                pageOrientation: 'landscape',
                content: [
                    { text: 'BẢNG LÃI SUẤT TẠM TÍNH', style: 'header', margin: [0,0,0,10] },
                    {
                        style: 'summaryTable',
                        table: {
                            widths: ['auto', '*'],
                            body: summary
                        },
                        layout: 'noBorders',
                        margin: [0,0,0,10]
                    },
                    {
                        style: 'mainTable',
                        table: {
                            headerRows: 1,
                            body: tableBody
                        },
                        layout: {
                            fillColor: function (rowIndex, node, columnIndex) {
                                return rowIndex === 0 ? '#228B22' : null;
                            },
                            hLineColor: function(i, node) { return '#888'; },
                            vLineColor: function(i, node) { return '#888'; },
                            hLineWidth: function(i, node) { return 0.7; },
                            vLineWidth: function(i, node) { return 0.7; }
                        }
                    }
                ],
                styles: {
                    header: { fontSize: 18, bold: true, alignment: 'center', color: '#228B22' },
                    summaryTable: { fontSize: 12, margin: [0,0,0,10] },
                    mainTable: { fontSize: 11 }
                },
                defaultStyle: {
                    font: 'Roboto'
                }
            };
            pdfMake.createPdf(docDefinition).download('lich_tra_no.pdf');
        }

        // Đảm bảo luôn cập nhật bảng trước khi tải file
        document.querySelector('button.btn-danger')?.addEventListener('click', function(e) {
            calculateSchedule();
            setTimeout(downloadPDF, 0);
            e.stopImmediatePropagation();
            return false;
        });
        document.querySelector('button.btn-success')?.addEventListener('click', function(e) {
            calculateSchedule();
            setTimeout(downloadExcel, 0);
            e.stopImmediatePropagation();
            return false;
        });

        // Lãi suất cố định theo ảnh: nhà ở (≤5 tỷ vs >5 tỷ), đất ở
        const fixedPackagesBds = {
            low: [
                { value: '6',  label: 'Cố định 6 tháng (6,70%/năm)',  rate: 6.7, months: 6 },
                { value: '12', label: 'Cố định 12 tháng (7,20%/năm)', rate: 7.2, months: 12 },
                { value: '18', label: 'Cố định 18 tháng (6m: 6,70% + 12m: 7,70%)', rate: 6.7, months: 6, secondRate: 7.7, secondMonths: 12 },
            ],
            high: [
                { value: '6',  label: 'Cố định 6 tháng (6,50%/năm)',  rate: 6.5, months: 6 },
                { value: '12', label: 'Cố định 12 tháng (7,00%/năm)', rate: 7.0, months: 12 },
                { value: '18', label: 'Cố định 18 tháng (6m: 6,50% + 12m: 7,50%)', rate: 6.5, months: 6, secondRate: 7.5, secondMonths: 12 },
            ]
        };
        const fixedPackages = {
            bds: fixedPackagesBds,
            land: [
                { value: '6',  label: 'Cố định 6 tháng (7,00%/năm)',  rate: 7.0, months: 6 },
                { value: '12', label: 'Cố định 12 tháng (7,50%/năm)', rate: 7.5, months: 12 },
                { value: '18', label: 'Cố định 18 tháng (6m: 7,00% + 12m: 8,00%)', rate: 7.0, months: 6, secondRate: 8.0, secondMonths: 12 },
            ],
        };
        const youngPackages = [
            { value: 'young_1', label: 'Gói người trẻ 1 (Cố định 5,8% - 36 tháng)', rate: 5.8, months: 36 },
            { value: 'young_2', label: 'Gói người trẻ 2 (Năm 1: 5,8%; Năm 2-3: LSTK 12T + 2%)', rate: 5.8, months: 12, secondRate: null, secondMonths: 24 }
        };
        // Không còn gói tiêu dùng; gói người trẻ tách riêng
        function renderFixedPackageOptions() {
            const purpose = document.querySelector('input[name="loanPurpose"]:checked').value;
            const select = document.getElementById('fixedPackage');
            const bucket = document.querySelector('input[name="houseBucket"]:checked')?.value || 'low';
            const houseBucketGroup = document.getElementById('houseValueBucketGroup');
            select.innerHTML = '';

            if (purpose === 'bds') {
                houseBucketGroup.style.display = '';
                (fixedPackages.bds[bucket] || []).forEach(pkg => {
                    const opt = document.createElement('option');
                    opt.value = pkg.value;
                    opt.textContent = pkg.label;
                    select.appendChild(opt);
                });
                if (select.options.length > 0) select.selectedIndex = 0;
            } else if (purpose === 'land') {
                houseBucketGroup.style.display = 'none';
                fixedPackages.land.forEach(pkg => {
                    const opt = document.createElement('option');
                    opt.value = pkg.value;
                    opt.textContent = pkg.label;
                    select.appendChild(opt);
                });
                if (select.options.length > 0) select.selectedIndex = 0;
            } else if (purpose === 'young') {
                houseBucketGroup.style.display = 'none';
                youngPackages.forEach(pkg => {
                    const opt = document.createElement('option');
                    opt.value = pkg.value;
                    opt.textContent = pkg.label;
                    select.appendChild(opt);
                });
                if (select.options.length > 0) select.selectedIndex = 0;
            }
            updateAfterFixedRateLabel();
            try { checkPackageTerm(); } catch(e) {}
        }
        // Gọi khi load và khi đổi mục đích
        document.addEventListener('DOMContentLoaded', renderFixedPackageOptions);
        document.getElementById('loanPurposeGroup').addEventListener('change', renderFixedPackageOptions);
        document.getElementById('houseValueBucketGroup').addEventListener('change', renderFixedPackageOptions);
    </script>
</body>
</html> 