<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch trả nợ chi tiết</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .step-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.95);
        }
        .step-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .hidden {
            display: none;
        }
        body {
            background-image: url('images/logo.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: contain;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .container {
            position: relative;
            z-index: 1;
        }
        .menu-btn {
            box-shadow: 0 4px 16px rgba(34,139,34,0.12), 0 1.5px 4px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s, transform 0.2s, background 0.2s;
            cursor: pointer;
            font-size: 1.08rem;
            font-weight: bold;
            padding: 0.7rem 1.2rem;
            border-radius: 10px;
        }
        .menu-btn:hover, .menu-btn:focus {
            box-shadow: 0 8px 24px rgba(34,139,34,0.18), 0 2px 8px rgba(0,0,0,0.12);
            transform: translateY(-2px) scale(1.03);
            background: #e6f4ea !important;
        }
        .blink-cursor {
            animation: blink-cursor 1s steps(2, start) infinite;
            color: #228B22;
            font-size: 1.2em;
            transform: scale(3);
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes blink-cursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
        .input-million-group {
            display: flex;
            align-items: center;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: #fff;
            overflow: hidden;
            width: fit-content;
            max-width: none;
            min-width: 0;
            height: 40px;
        }
        .input-million-group input,
        .input-million {
            min-width: 4ch;
            width: auto;
            border: none;
            box-shadow: none;
            outline: none;
            border-radius: 0;
            background: transparent;
            flex: 1 1 0;
            text-align: right;
            padding: 6px 0 6px 8px;
            font-size: 1rem;
            height: 40px;
            line-height: 40px;
            display: block;
        }
        .input-million-suffix {
            background: transparent;
            border: none;
            padding: 0 8px 0 2px;
            color: #212529;
            font-size: 1rem;
            font-weight: 400;
            line-height: 40px;
            height: 40px;
            display: flex;
            align-items: center;
        }
        @media print {
            body * {
                visibility: hidden !important;
            }
            #scheduleTable, #scheduleTable * {
                visibility: visible !important;
            }
            #scheduleTable {
                position: absolute;
                left: 0;
                top: 0;
                width: 100vw;
                margin: 0;
                padding: 0;
                background: #fff !important;
            }
            .step-container, .step-header, .table-responsive, table {
                background: #fff !important;
                color: #000 !important;
            }
            .table th, .table td {
                background: #fff !important;
                color: #000 !important;
                border: 1px solid #333 !important;
            }
            .container, .step-container {
                box-shadow: none !important;
            }
            .d-flex, .btn, .menu-btn, .input-million-group, .input-million-suffix, .input-million, .form-label, .form-control, .form-select {
                box-shadow: none !important;
            }
            /* Ẩn các nút, chỉ in bảng */
            .btn, .menu-btn, .input-million-group, .input-million-suffix, .input-million, .form-label, .form-control, .form-select, #inputForm, .d-flex.flex-column, .d-flex.gap-2, .d-flex.justify-content-between {
                display: none !important;
            }
            h1, .step-header h3 {
                text-align: center !important;
                color: #228B22 !important;
                font-size: 2rem !important;
                margin-bottom: 1rem !important;
            }
            #scheduleTable .table-responsive {
                overflow-x: visible !important;
            }
            #scheduleTable table {
                min-width: 1200px !important;
                width: 100% !important;
                font-size: 12px !important;
                table-layout: auto !important;
            }
            .table th, .table td {
                white-space: nowrap !important;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex flex-column align-items-start mb-3 gap-2">
            <button type="button" class="btn btn-sm fw-bold menu-btn"
                style="background-color: #ffe066; color: #228B22; min-width: 260px; border: none;"
                onclick="window.location.href='projects.html'">
                <img src="images/mouse.png" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
                DANH MỤC CÁC DỰ ÁN LIÊN KẾT VỚI VCB THỦ THIÊM
            </button>
            <button type="button" class="btn btn-sm fw-bold menu-btn"
                style="background-color: #ffe066; color: #228B22; min-width: 260px; border: none;"
                onclick="window.location.href='laisuat.html'">
                <img src="images/mouse.png" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
                CÁC GÓI LÃI SUẤT CHO VAY KHCN HIỆN HÀNH
            </button>
            <button type="button" class="btn btn-sm fw-bold menu-btn"
                style="background-color: #ffe066; color: #228B22; min-width: 260px; border: none;"
                onclick="window.location.href='hosovay.html'">
                <img src="images/mouse.png" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
                DANH MỤC HỒ SƠ VAY VỐN KHÁCH HÀNG CUNG CẤP
            </button>
            <button type="button" class="btn btn-sm fw-bold menu-btn"
                style="background-color: #ffe066; color: #228B22; min-width: 260px; border: none;"
                onclick="window.location.href='bodieukien.html'">
                <img src="images/mouse.png" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
                BỘ ĐIỀU KIỆN SẢN PHẨM NHÀ DỰ ÁN
            </button>
        </div>
        <h1 class="text-center mb-4">Lịch trả nợ chi tiết</h1>

        <!-- Form nhập liệu -->
        <div class="step-container" id="inputForm">
            <div class="step-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Thông tin khoản vay</h3>
                <button type="button" class="btn btn-secondary btn-sm fw-bold" onclick="window.location.href='index.html'">
                    <i class="bi bi-arrow-left"></i> Quay lại
                </button>
            </div>
            <form id="loanForm">
                <div class="mb-3">
                    <label for="assetValue_million" class="form-label">Giá trị tài sản mua/Tài sản bảo đảm (VND)</label>
                    <div class="input-million-group">
                        <input type="text" id="assetValue_million" maxlength="8" size="4" autocomplete="off" class="input-million">
                        <span class="input-million-suffix">.000.000</span>
                    </div>
                    <span id="assetValue_display" class="ms-2 text-success"></span>
                </div>
                <div class="mb-3">
                    <label for="loanAmount_million" class="form-label">Số tiền vay (VND)</label>
                    <div class="input-million-group">
                        <input type="text" id="loanAmount_million" maxlength="8" size="4" autocomplete="off" class="input-million">
                        <span class="input-million-suffix">.000.000</span>
                    </div>
                    <span id="loanAmount_display" class="ms-2 text-success"></span>
                </div>
                <div id="fixedPackageHighlight" class="mb-3 p-3 border border-primary rounded" style="background-color: #fffacd;">
                    <label for="fixedPackage" class="form-label fw-bold" style="font-size:1.15rem; color:#0d6efd;">
                        <i class="bi bi-star-fill"></i> Chọn gói cố định lãi suất
                    </label>
                    <select class="form-select" id="fixedPackage">
                        <option value="12">Cố định 12 tháng (6%/năm)</option>
                        <option value="18">Cố định 18 tháng (6.3%/năm)</option>
                        <option value="24">Cố định 24 tháng (6.5%/năm)</option>
                        <option value="36">Cố định 36 tháng (8%/năm)</option>
                        <option value="young_1">Gói ưu đãi đặc biệt cho người trẻ 1 (5.5% - 36 tháng, ân hạn gốc tối đa 5 năm)</option>
                        <option value="young_2">Gói ưu đãi đặc biệt cho người trẻ 2 (5.2% - 12 tháng, 6.6% - 24 tháng, ân hạn gốc tối đa 5 năm)</option>
                    </select>
                    <div id="gracePeriodGroup" class="mt-3" style="display:none;">
                        <label for="gracePeriod" class="form-label">Chọn thời gian ân hạn gốc (tháng)</label>
                        <select class="form-select" id="gracePeriod">
                            <option value="12">12 tháng (1 năm)</option>
                            <option value="24">24 tháng (2 năm)</option>
                            <option value="36">36 tháng (3 năm)</option>
                            <option value="48">48 tháng (4 năm)</option>
                            <option value="60">60 tháng (5 năm)</option>
                        </select>
                    </div>
                    <div id="graceError" class="text-danger mt-2" style="display:none;">Thời hạn vay phải lớn hơn hoặc bằng thời gian ân hạn gốc!</div>
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Thời hạn vay (tháng)</label>
                    <input type="number" class="form-control" id="loanTerm" required min="1">
                </div>
                <div class="mb-3">
                    <label for="afterFixedRate" class="form-label">Lãi suất sau thời gian ưu đãi tạm tính (%/năm)</label>
                    <input type="number" class="form-control" id="afterFixedRate" min="0" step="0.1" value="9.0">
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-primary" onclick="calculateSchedule()">Xem lịch trả nợ</button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" onclick="printSchedule()">
                            <i class="bi bi-printer"></i> In ra PDF
                        </button>
                        <button type="button" class="btn btn-danger" onclick="downloadPDF()">
                            <i class="bi bi-file-earmark-pdf"></i> Tải file PDF
                        </button>
                        <button type="button" class="btn btn-success" onclick="downloadExcel()">
                            <i class="bi bi-download"></i> Tải file Excel
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Bảng lịch trả nợ -->
        <div class="step-container" id="scheduleTable" style="display: none;">
            <div class="step-header">
                <h3>Chi tiết lịch trả nợ(tạm tính)</h3>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Kỳ</th>
                            <th>Ngày thanh toán</th>
                            <th>Dư nợ đầu kỳ</th>
                            <th>Gốc trả hàng tháng</th>
                            <th>Dư nợ cuối kỳ</th>
                            <th>Lãi suất/năm</th>
                            <th>Nợ lãi phải trả</th>
                            <th>Tổng nợ gốc và lãi phải trả tạm tính</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://unpkg.com/@jsreport/jsreport-pdf-font-dejavu@1.0.0/dist/jsreport-pdf-font-dejavu.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Hàm định dạng số với dấu chấm ngăn cách
        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Hàm chuyển đổi chuỗi số có dấu chấm thành số
        function parseFormattedNumber(str) {
            return parseInt(str.replace(/\./g, '')) || 0;
        }

        // Hàm chuyển đổi số thành định dạng tiền tệ
        function formatCurrency(amount) {
            if (!amount || isNaN(amount)) return '0 VND';
            return amount.toLocaleString('vi-VN') + ' VND';
        }

        // Hàm format tiền
        function formatMoney(million) {
            if (!million || isNaN(million)) return '';
            let num = parseInt(million);
            if (num >= 1000) {
                let ty = Math.floor(num / 1000);
                let trieu = num % 1000;
                if (trieu === 0) return ty + ' tỷ đồng';
                return ty + ' tỷ ' + trieu + ' triệu đồng';
            }
            return num + ' triệu đồng';
        }

        // Gán sự kiện cho các input triệu
        function setupMillionInput(inputId, displayId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            input.addEventListener('input', function() {
                let value = input.value.replace(/\D/g, '').substring(0,8);
                input.value = value ? formatNumber(value) : '';
                display.textContent = formatMoney(value);
            });
            input.addEventListener('blur', function() {
                let value = input.value.replace(/\D/g, '').substring(0,8);
                input.value = value ? formatNumber(value) : '';
                display.textContent = formatMoney(value);
            });
            // Hiển thị mặc định
            display.textContent = '';
        }
        setupMillionInput('assetValue_million', 'assetValue_display');
        setupMillionInput('loanAmount_million', 'loanAmount_display');

        // Hàm kiểm tra ngày nghỉ lễ
        function isHoliday(date) {
            // Danh sách ngày nghỉ lễ cố định (dd-mm)
            const holidays = [
                '01-01', // Tết Dương lịch
                '30-04', // Giải phóng miền Nam
                '01-05', // Quốc tế Lao động
                '02-09', // Quốc khánh
            ];
            const ddmm = (date.getDate().toString().padStart(2, '0')) + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
            // Chỉ kiểm tra ngày nghỉ lễ, KHÔNG kiểm tra cuối tuần
            return holidays.includes(ddmm);
        }
        // Hàm tìm ngày làm việc gần nhất sau ngày truyền vào (chỉ bỏ qua ngày nghỉ lễ)
        function getNextWorkingDay(date) {
            let d = new Date(date);
            while (isHoliday(d)) {
                d.setDate(d.getDate() + 1);
            }
            return d;
        }

        // Hàm kiểm tra và dời ngày nếu rơi vào thứ 7/CN
        function adjustToNextMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            if (day === 6) { // Thứ 7
                d.setDate(d.getDate() + 2);
            } else if (day === 0) { // Chủ nhật
                d.setDate(d.getDate() + 1);
            }
            return d;
        }

        // Hàm tính lịch trả nợ
        function calculateSchedule() {
            const assetValue = parseFormattedNumber(document.getElementById('assetValue_million').value) * 1000000;
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount_million').value) * 1000000;
            const term = parseInt(document.getElementById('loanTerm').value);
            const fixedPackage = document.getElementById('fixedPackage').value;
            const afterFixedRate = parseFloat(document.getElementById('afterFixedRate').value);
            let graceMonths = 0;
            if (fixedPackage === 'young_1' || fixedPackage === 'young_2') {
                graceMonths = parseInt(document.getElementById('gracePeriod').value) || 60;
            }

            // Kiểm tra số tiền vay không được vượt quá giá trị tài sản
            if (assetValue > 0 && loanAmount > 0 && loanAmount > assetValue) {
                alert('Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!');
                return;
            }
            // Kiểm tra điều kiện gói và thời hạn vay
            if (!checkPackageTerm()) {
                return;
            }

            if (loanAmount > 0 && term > 0) {
                // Tính lãi suất cố định và thời gian ân hạn dựa trên gói đã chọn
                let fixedRate = 6.0;
                let secondFixedRate = null;
                let fixedMonths = 12;
                let secondFixedMonths = 0;

                if (fixedPackage === '12') {
                    fixedRate = 6.0;
                    fixedMonths = 12;
                } else if (fixedPackage === '18') {
                    fixedRate = 6.3;
                    fixedMonths = 18;
                } else if (fixedPackage === '24') {
                    fixedRate = 6.5;
                    fixedMonths = 24;
                } else if (fixedPackage === '36') {
                    fixedRate = 8.0;
                    fixedMonths = 36;
                } else if (fixedPackage === 'young_1') {
                    fixedRate = 5.5;
                    fixedMonths = 36;
                } else if (fixedPackage === 'young_2') {
                    fixedRate = 5.2;
                    secondFixedRate = 6.6;
                    fixedMonths = 12;
                    secondFixedMonths = 24;
                }

                const monthlyRate = fixedRate / 12 / 100;
                const secondMonthlyRate = secondFixedRate ? secondFixedRate / 12 / 100 : null;
                const afterMonthlyRate = afterFixedRate / 12 / 100;
                
                let remainingPrincipal = loanAmount;
                const scheduleBody = document.getElementById('scheduleBody');
                scheduleBody.innerHTML = '';

                const today = new Date();
                let openingPrincipal = loanAmount;
                for (let i = 1; i <= term; i++) {
                    // Xác định lãi suất áp dụng cho kỳ hiện tại
                    let currentRate, currentRateYear;
                    if (i <= fixedMonths) {
                        currentRate = monthlyRate;
                        currentRateYear = fixedRate;
                    } else if (secondFixedRate && i <= fixedMonths + secondFixedMonths) {
                        currentRate = secondMonthlyRate;
                        currentRateYear = secondFixedRate;
                    } else {
                        currentRate = afterMonthlyRate;
                        currentRateYear = afterFixedRate;
                    }

                    const interestPayment = openingPrincipal * currentRate;
                    // Tính gốc trả hàng tháng
                    let monthlyPrincipal = 0;
                    if (i > graceMonths) {
                        monthlyPrincipal = loanAmount / (term - graceMonths);
                    }
                    // Dư nợ cuối kỳ
                    let closingPrincipal = openingPrincipal - monthlyPrincipal;
                    if (closingPrincipal < 0) closingPrincipal = 0;
                    // Ngày thanh toán: ngày 5 mỗi tháng, nếu rơi vào ngày nghỉ lễ thì chuyển sang ngày làm việc gần nhất sau đó
                    const paymentDate = new Date(today.getFullYear(), today.getMonth() + i, 5);
                    let workingDate = getNextWorkingDay(paymentDate);
                    workingDate = adjustToNextMonday(workingDate);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${i}</td>
                        <td>${workingDate.toLocaleDateString('vi-VN')}</td>
                        <td>${formatCurrency(Math.round(openingPrincipal))}</td>
                        <td>${formatCurrency(Math.round(monthlyPrincipal))}</td>
                        <td>${formatCurrency(Math.round(closingPrincipal))}</td>
                        <td>${currentRateYear.toFixed(2)}%</td>
                        <td>${formatCurrency(Math.round(interestPayment))}</td>
                        <td>${formatCurrency(Math.round(monthlyPrincipal + interestPayment))}</td>
                    `;
                    scheduleBody.appendChild(row);
                    // Sang kỳ tiếp theo, đầu kỳ = cuối kỳ kỳ trước
                    openingPrincipal = closingPrincipal;
                }

                document.getElementById('scheduleTable').style.display = 'block';
            }
        }

        // Hàm reset form
        function resetForm() {
            document.getElementById('assetValue_million').value = '';
            document.getElementById('loanAmount_million').value = '';
            document.getElementById('loanTerm').value = '';
            document.getElementById('fixedPackage').value = '12';
            document.getElementById('afterFixedRate').value = '9.0';
            document.getElementById('scheduleTable').style.display = 'none';

            // Reset trạng thái disable của các gói
            const fixedPackage = document.getElementById('fixedPackage');
            const options = fixedPackage.options;
            for (let i = 0; i < options.length; i++) {
                options[i].disabled = false;
            }
        }

        // Load dữ liệu từ index.html khi trang được tải
        window.addEventListener('load', function() {
            const loanData = JSON.parse(localStorage.getItem('loanData')) || {};
            if (loanData.assetValue) {
                const assetValue = Math.floor(loanData.assetValue / 1000000) || '';
                document.getElementById('assetValue_million').value = assetValue ? formatNumber(assetValue) : '';
                document.getElementById('assetValue_display').textContent = formatMoney(assetValue);
            }
            if (loanData.loanAmount) {
                const loanAmount = Math.floor(loanData.loanAmount / 1000000) || '';
                document.getElementById('loanAmount_million').value = loanAmount ? formatNumber(loanAmount) : '';
                document.getElementById('loanAmount_display').textContent = formatMoney(loanAmount);
            }
            if (loanData.loanTerm) {
                document.getElementById('loanTerm').value = loanData.loanTerm;
            }
            
            calculateSchedule();
        });

        // Thêm định dạng số cho các input tiền
        ['assetValue_million', 'loanAmount_million'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\./g, '');
                if (value) {
                    if (value.length > 12) {
                        value = value.slice(0, 12);
                    }
                    value = parseInt(value);
                    e.target.value = formatNumber(value);
                }
            });
        });

        // Thêm event listener cho input số tiền vay
        document.getElementById('loanAmount_million').addEventListener('input', function(e) {
            const assetValue = parseFormattedNumber(document.getElementById('assetValue_million').value) * 1000000;
            const loanAmount = parseFormattedNumber(e.target.value) * 1000000;
            // Nếu chưa nhập giá trị tài sản thì không cảnh báo
            if (!assetValue || assetValue === 0) {
                e.target.classList.remove('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
                return;
            }
            if (loanAmount > assetValue) {
                e.target.classList.add('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback';
                    div.textContent = 'Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!';
                    e.target.parentNode.insertBefore(div, e.target.nextSibling);
                }
            } else {
                e.target.classList.remove('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
            }
        });

        // Thêm event listener cho input giá trị tài sản
        document.getElementById('assetValue_million').addEventListener('input', function(e) {
            const assetValue = parseFormattedNumber(e.target.value) * 1000000;
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount_million').value) * 1000000;
            // Nếu chưa nhập giá trị tài sản thì không cảnh báo
            if (!assetValue || assetValue === 0) {
                const loanAmountInput = document.getElementById('loanAmount_million');
                loanAmountInput.classList.remove('is-invalid');
                const feedback = loanAmountInput.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
                return;
            }
            if (loanAmount > assetValue) {
                const loanAmountInput = document.getElementById('loanAmount_million');
                loanAmountInput.classList.add('is-invalid');
                const feedback = loanAmountInput.nextElementSibling;
                if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback';
                    div.textContent = 'Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!';
                    loanAmountInput.parentNode.insertBefore(div, loanAmountInput.nextSibling);
                }
            } else {
                const loanAmountInput = document.getElementById('loanAmount_million');
                loanAmountInput.classList.remove('is-invalid');
                const feedback = loanAmountInput.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
            }
        });

        // --- Thêm xử lý cho phần chọn gói và ân hạn ---
        const fixedPackageSelect = document.getElementById('fixedPackage');
        const gracePeriodGroup = document.getElementById('gracePeriodGroup');
        const gracePeriodSelect = document.getElementById('gracePeriod');
        const loanTermInput = document.getElementById('loanTerm');
        const graceError = document.getElementById('graceError');
        // Thêm dòng báo lỗi cho các gói thường
        let packageError = document.getElementById('packageError');
        if (!packageError) {
            packageError = document.createElement('div');
            packageError.id = 'packageError';
            packageError.className = 'text-danger mt-2';
            packageError.style.display = 'none';
            fixedPackageSelect.parentNode.appendChild(packageError);
        }

        function checkPackageTerm() {
            const fixedPackage = fixedPackageSelect.value;
            const term = parseInt(loanTermInput.value) || 0;
            let valid = true;
            let errorMsg = '';
            // Nếu thời hạn vay chưa nhập hoặc = 0 thì không báo lỗi gì cả
            if (!loanTermInput.value || term === 0) {
                gracePeriodGroup.style.display = (fixedPackage === 'young_1' || fixedPackage === 'young_2') ? '' : 'none';
                graceError.style.display = 'none';
                packageError.textContent = '';
                packageError.style.display = 'none';
                return true;
            }
            // Gói ân hạn
            if (fixedPackage === 'young_1' || fixedPackage === 'young_2') {
                gracePeriodGroup.style.display = '';
                const graceMonths = parseInt(gracePeriodSelect.value);
                if (term > 0 && graceMonths > 0 && term < graceMonths) {
                    graceError.style.display = '';
                    valid = false;
                } else {
                    graceError.style.display = 'none';
                }
            } else {
                gracePeriodGroup.style.display = 'none';
                graceError.style.display = 'none';
                // Các gói thường: kiểm tra thời hạn vay >= số tháng của gói
                let minMonths = parseInt(fixedPackage);
                if (!isNaN(minMonths) && term > 0 && term < minMonths) {
                    errorMsg = `Thời hạn vay phải lớn hơn hoặc bằng số tháng của gói (${minMonths} tháng)!`;
                    valid = false;
                }
            }
            // Hiện hoặc ẩn lỗi cho gói thường
            if (errorMsg) {
                packageError.textContent = errorMsg;
                packageError.style.display = '';
            } else {
                packageError.textContent = '';
                packageError.style.display = 'none';
            }
            return valid && graceError.style.display === 'none';
        }

        fixedPackageSelect.addEventListener('change', checkPackageTerm);
        gracePeriodSelect.addEventListener('change', checkPackageTerm);
        loanTermInput.addEventListener('input', checkPackageTerm);

        function downloadExcel() {
            // 1. Lấy thông tin khoản vay
            const assetValue = parseFormattedNumber(document.getElementById('assetValue_million').value) * 1000000;
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount_million').value) * 1000000;
            const term = parseInt(document.getElementById('loanTerm').value);
            const fixedPackage = document.getElementById('fixedPackage');
            const fixedPackageText = fixedPackage.options[fixedPackage.selectedIndex].text;
            const afterFixedRate = parseFloat(document.getElementById('afterFixedRate').value);
            let graceMonths = 0;
            let graceText = '';
            if (fixedPackage.value === 'young_1' || fixedPackage.value === 'young_2') {
                graceMonths = parseInt(document.getElementById('gracePeriod').value) || 60;
                graceText = graceMonths + ' tháng';
            }
            // Ngày trả nợ đầu tiên
            const today = new Date();
            const firstPayment = new Date(today.getFullYear(), today.getMonth() + 1, 5);
            // 0. Thêm dòng tiêu đề lớn
            const titleRow = ['BẢNG LÃI SUẤT TẠM TÍNH'];
            // 2. Tạo dữ liệu phần tóm tắt
            const summary = [
                ['SỐ TIỀN VAY', loanAmount ? formatNumber(loanAmount) : ''],
                ['THỜI GIAN VAY', term ? term : ''],
                ['LÃI SUẤT ƯU ĐÃI', fixedPackageText.match(/\d+(\.\d+)?%/) ? fixedPackageText.match(/\d+(\.\d+)?%/)[0] : ''],
                ['Thời gian ưu đãi', fixedPackage.value === 'young_2' ? '12 tháng (5.2%), 24 tháng (6.6%)' : (fixedPackage.value === 'young_1' ? '36 tháng (5.5%)' : (fixedPackage.value + ' tháng'))],
                ['Lãi suất thả nổi', afterFixedRate ? afterFixedRate.toFixed(2) + '%' : ''],
                ['Ngày giải ngân dự kiến', today.toLocaleDateString('vi-VN')],
                ['Ngày trả nợ đầu tiên', firstPayment.toLocaleDateString('vi-VN')],
            ];
            if (graceText) summary.push(['Người nhận ưu đãi ân hạn gốc', graceText]);
            // 3. Lấy dữ liệu bảng lịch trả nợ
            const headerCells = document.querySelectorAll('#scheduleTable thead tr th');
            const headers = Array.from(headerCells).map(cell => cell.textContent.trim());
            const rows = document.querySelectorAll('#scheduleTable tbody tr');
            const scheduleData = [headers];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => cell.textContent.trim());
                scheduleData.push(rowData);
            });
            // 4. Gộp dữ liệu vào 1 sheet
            let ws_data = [];
            ws_data.push(titleRow);
            ws_data.push([]); // dòng trống
            summary.forEach(row => ws_data.push(row));
            ws_data.push([]); // dòng trống
            scheduleData.forEach(row => ws_data.push(row));
            // 5. Tạo workbook và xuất file
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            // Merge ô cho dòng tiêu đề lớn
            ws['!merges'] = ws['!merges'] || [];
            ws['!merges'].push({s: {r:0, c:0}, e: {r:0, c:headers.length-1}});
            // Định dạng font đậm, lớn, căn giữa, wrap text cho dòng đầu
            ws['A1'].s = {
                font: { bold: true, sz: 16 },
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true }
            };
            // Định dạng phần tóm tắt: căn trái, wrap text
            for (let i = 2; i < 2 + summary.length; i++) {
                const cellA = ws[`A${i+1}`];
                const cellB = ws[`B${i+1}`];
                if (cellA) cellA.s = { font: { bold: true }, alignment: { horizontal: 'left', wrapText: true } };
                if (cellB) cellB.s = { alignment: { horizontal: 'left', wrapText: true } };
            }
            // Định dạng header bảng chi tiết: đậm, căn giữa, wrap text
            const headerRowIdx = 2 + summary.length + 2;
            for (let c = 0; c < headers.length; c++) {
                const col = String.fromCharCode(65 + c);
                const cell = ws[`${col}${headerRowIdx+1}`];
                if (cell) cell.s = { font: { bold: true }, alignment: { horizontal: 'center', wrapText: true } };
            }
            // Định dạng dữ liệu bảng chi tiết
            for (let r = headerRowIdx + 1; r < ws_data.length; r++) {
                for (let c = 0; c < headers.length; c++) {
                    const col = String.fromCharCode(65 + c);
                    const cell = ws[`${col}${r+1}`];
                    if (cell) {
                        // Cột số: căn phải, wrap text; Cột ngày/kỳ: căn giữa
                        if (c === 0 || c === 1) {
                            cell.s = { alignment: { horizontal: 'center', wrapText: true } };
                        } else {
                            cell.s = { alignment: { horizontal: 'right', wrapText: true } };
                        }
                    }
                }
            }
            // Set width cho các cột hợp lý hơn
            ws['!cols'] = headers.map((h, idx) => {
                if (idx === 0) return { wch: 5 };
                if (idx === 1) return { wch: 13 };
                if (h.includes('Dư nợ')) return { wch: 18 };
                if (h.includes('Gốc')) return { wch: 15 };
                if (h.includes('Lãi')) return { wch: 15 };
                if (h.includes('Tổng')) return { wch: 22 };
                return { wch: 12 };
            });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'LichTraNo');
            XLSX.writeFile(wb, 'lich_tra_no.xlsx');
        }

        // Hàm bỏ dấu tiếng Việt
        function removeVietnameseTones(str) {
            return str.normalize('NFD')
                .replace(/\p{Diacritic}/gu, '')
                .replace(/đ/g, 'd').replace(/Đ/g, 'D');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            let y = 12;
            // Tiêu đề lớn
            doc.setFontSize(18);
            doc.setFont('DejaVu', 'bold');
            doc.text(removeVietnameseTones('BẢNG LÃI SUẤT TẠM TÍNH'), 148, y, { align: 'center' });
            y += 8;
            // Lấy thông tin tóm tắt
            const assetValue = parseFormattedNumber(document.getElementById('assetValue_million').value) * 1000000;
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount_million').value) * 1000000;
            const term = parseInt(document.getElementById('loanTerm').value);
            const fixedPackage = document.getElementById('fixedPackage');
            const fixedPackageText = fixedPackage.options[fixedPackage.selectedIndex].text;
            const afterFixedRate = parseFloat(document.getElementById('afterFixedRate').value);
            let graceMonths = 0;
            let graceText = '';
            if (fixedPackage.value === 'young_1' || fixedPackage.value === 'young_2') {
                graceMonths = parseInt(document.getElementById('gracePeriod').value) || 60;
                graceText = graceMonths + ' thang';
            }
            const today = new Date();
            const firstPayment = new Date(today.getFullYear(), today.getMonth() + 1, 5);
            // Tóm tắt
            const summary = [
                [removeVietnameseTones('SỐ TIỀN VAY'), loanAmount ? formatNumber(loanAmount) : ''],
                [removeVietnameseTones('THỜI GIAN VAY'), term ? term : ''],
                [removeVietnameseTones('LÃI SUẤT ƯU ĐÃI'), fixedPackageText.match(/\d+(\.\d+)?%/) ? fixedPackageText.match(/\d+(\.\d+)?%/)[0] : ''],
                [removeVietnameseTones('Thời gian ưu đãi'), fixedPackage.value === 'young_2' ? '12 thang (5.2%), 24 thang (6.6%)' : (fixedPackage.value === 'young_1' ? '36 thang (5.5%)' : (fixedPackage.value + ' thang'))],
                [removeVietnameseTones('Lãi suất thả nổi'), afterFixedRate ? afterFixedRate.toFixed(2) + '%' : ''],
                [removeVietnameseTones('Ngày giải ngân dự kiến'), today.toLocaleDateString('vi-VN')],
                [removeVietnameseTones('Ngày trả nợ đầu tiên'), firstPayment.toLocaleDateString('vi-VN')],
            ];
            if (graceText) summary.push([removeVietnameseTones('Người nhận ưu đãi ân hạn gốc'), graceText]);
            // In tóm tắt
            doc.setFontSize(12);
            doc.setFont('DejaVu', 'normal');
            summary.forEach(row => {
                doc.text(`${row[0]}:`, 18, y);
                doc.text(`${row[1]}`, 70, y);
                y += 7;
            });
            y += 2;
            // Lấy bảng lịch trả nợ
            const headerCells = document.querySelectorAll('#scheduleTable thead tr th');
            // Chuyển header sang không dấu
            const headers = Array.from(headerCells).map(cell => removeVietnameseTones(cell.textContent.trim()));
            const rows = document.querySelectorAll('#scheduleTable tbody tr');
            const data = [];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => cell.textContent.trim());
                data.push(rowData);
            });
            // In bảng chi tiết
            doc.autoTable({
                head: [headers],
                body: data,
                startY: y,
                theme: 'grid',
                headStyles: { fillColor: [34, 139, 34], textColor: 255, fontStyle: 'bold', halign: 'center', fontSize: 11 },
                bodyStyles: { fontSize: 10, halign: 'right', valign: 'middle' },
                styles: { cellPadding: 2, overflow: 'linebreak', minCellHeight: 7, font: 'DejaVu' },
                columnStyles: {
                    0: { halign: 'center' }, // Ky
                    1: { halign: 'center' }, // Ngay thanh toan
                    2: { halign: 'right' },
                    3: { halign: 'right' },
                    4: { halign: 'right' },
                    5: { halign: 'center' },
                    6: { halign: 'right' },
                    7: { halign: 'right' },
                },
                margin: { left: 12, right: 12 },
                tableWidth: 'auto',
            });
            doc.save('lich_tra_no.pdf');
        }

        function printSchedule() {
            window.print();
        }
    </script>
</body>
</html> 