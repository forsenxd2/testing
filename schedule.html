<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch trả nợ chi tiết</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .step-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.95);
        }
        .step-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .hidden {
            display: none;
        }
        body {
            background-image: url('images/logo.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: contain;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .container {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Lịch trả nợ chi tiết</h1>

        <!-- Form nhập liệu -->
        <div class="step-container" id="inputForm">
            <div class="step-header">
                <h3>Thông tin khoản vay</h3>
            </div>
            <form id="loanForm">
                <div class="mb-3">
                    <label for="assetValue" class="form-label">Giá trị tài sản mua/Tài sản bảo đảm (VND)</label>
                    <input type="text" class="form-control" id="assetValue" required min="0" max="999999999999">
                </div>
                <div class="mb-3">
                    <label for="loanAmount" class="form-label">Số tiền vay (VND)</label>
                    <input type="text" class="form-control" id="loanAmount" required min="0" max="999999999999">
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Thời hạn vay (tháng)</label>
                    <input type="number" class="form-control" id="loanTerm" required min="1">
                </div>
                <div class="mb-3">
                    <label for="fixedPackage" class="form-label">Chọn gói cố định lãi suất</label>
                    <select class="form-select" id="fixedPackage">
                        <option value="12">Cố định 12 tháng (6%/năm)</option>
                        <option value="18">Cố định 18 tháng (6.3%/năm)</option>
                        <option value="24">Cố định 24 tháng (6.5%/năm)</option>
                        <option value="36">Cố định 36 tháng (8%/năm)</option>
                        <option value="young_1">Gói ưu đãi đặc biệt cho người trẻ 1 (5.5% - 36 tháng, ân hạn gốc 5 năm)</option>
                        <option value="young_2">Gói ưu đãi đặc biệt cho người trẻ 2 (5.2% - 12 tháng, 6.6% - 24 tháng, ân hạn gốc 5 năm)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="afterFixedRate" class="form-label">Lãi suất sau thời gian ưu đãi (%/năm)</label>
                    <input type="number" class="form-control" id="afterFixedRate" min="0" step="0.1" value="9.0">
                </div>
                <div class="text-center">
                    <button type="button" class="btn btn-primary" onclick="calculateSchedule()">Xem lịch trả nợ</button>
                </div>
            </form>
        </div>

        <!-- Bảng lịch trả nợ -->
        <div class="step-container" id="scheduleTable" style="display: none;">
            <div class="step-header">
                <h3>Chi tiết lịch trả nợ</h3>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Kỳ</th>
                            <th>Ngày thanh toán</th>
                            <th>Gốc còn lại</th>
                            <th>Gốc trả</th>
                            <th>Lãi trả</th>
                            <th>Tổng phải trả</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Nút điều hướng -->
        <div class="d-flex justify-content-between mb-4">
            <button type="button" class="btn btn-secondary btn-lg" onclick="window.location.href='index.html'">
                <i class="bi bi-arrow-left"></i> Quay lại
            </button>
            <button type="button" class="btn btn-warning btn-lg" onclick="resetForm()">
                <i class="bi bi-arrow-counterclockwise"></i> Bắt đầu lại
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script>
        // Hàm định dạng số với dấu chấm ngăn cách
        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Hàm chuyển đổi chuỗi số có dấu chấm thành số
        function parseFormattedNumber(str) {
            return parseInt(str.replace(/\./g, '')) || 0;
        }

        // Hàm chuyển đổi số thành định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Hàm tính lịch trả nợ
        function calculateSchedule() {
            const assetValue = parseFormattedNumber(document.getElementById('assetValue').value);
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount').value);
            const term = parseInt(document.getElementById('loanTerm').value);
            const fixedPackage = document.getElementById('fixedPackage').value;
            const afterFixedRate = parseFloat(document.getElementById('afterFixedRate').value);

            // Kiểm tra số tiền vay không được vượt quá giá trị tài sản
            if (loanAmount > assetValue) {
                alert('Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!');
                return;
            }

            if (loanAmount > 0 && term > 0) {
                // Tính lãi suất cố định và thời gian ân hạn dựa trên gói đã chọn
                let fixedRate = 6.0;
                let secondFixedRate = null;
                let fixedMonths = 12;
                let secondFixedMonths = 0;
                let graceMonths = 0;

                if (fixedPackage === '12') {
                    fixedRate = 6.0;
                    fixedMonths = 12;
                } else if (fixedPackage === '18') {
                    fixedRate = 6.3;
                    fixedMonths = 18;
                } else if (fixedPackage === '24') {
                    fixedRate = 6.5;
                    fixedMonths = 24;
                } else if (fixedPackage === '36') {
                    fixedRate = 8.0;
                    fixedMonths = 36;
                } else if (fixedPackage === 'young_1') {
                    fixedRate = 5.5;
                    fixedMonths = 36;
                    graceMonths = 60; // 5 năm ân hạn gốc
                } else if (fixedPackage === 'young_2') {
                    fixedRate = 5.2;
                    secondFixedRate = 6.6;
                    fixedMonths = 12;
                    secondFixedMonths = 24;
                    graceMonths = 60; // 5 năm ân hạn gốc
                }

                const monthlyRate = fixedRate / 12 / 100;
                const secondMonthlyRate = secondFixedRate ? secondFixedRate / 12 / 100 : null;
                const afterMonthlyRate = afterFixedRate / 12 / 100;
                
                let remainingPrincipal = loanAmount;
                const scheduleBody = document.getElementById('scheduleBody');
                scheduleBody.innerHTML = '';

                const today = new Date();
                
                for (let i = 1; i <= term; i++) {
                    // Xác định lãi suất áp dụng cho kỳ hiện tại
                    let currentRate;
                    if (i <= fixedMonths) {
                        currentRate = monthlyRate;
                    } else if (secondFixedRate && i <= fixedMonths + secondFixedMonths) {
                        currentRate = secondMonthlyRate;
                    } else {
                        currentRate = afterMonthlyRate;
                    }

                    const interestPayment = remainingPrincipal * currentRate;
                    
                    // Tính gốc trả hàng tháng
                    let monthlyPrincipal = 0;
                    if (i > graceMonths) {
                        // Chia đều số tiền gốc cho số tháng còn lại sau ân hạn
                        monthlyPrincipal = loanAmount / (term - graceMonths);
                    }
                    
                    const totalPayment = monthlyPrincipal + interestPayment;
                    
                    remainingPrincipal -= monthlyPrincipal;
                    if (remainingPrincipal < 0) remainingPrincipal = 0;

                    const paymentDate = new Date(today);
                    paymentDate.setMonth(today.getMonth() + i);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${i}</td>
                        <td>${paymentDate.toLocaleDateString('vi-VN')}</td>
                        <td>${formatCurrency(Math.round(remainingPrincipal))}</td>
                        <td>${formatCurrency(Math.round(monthlyPrincipal))}</td>
                        <td>${formatCurrency(Math.round(interestPayment))}</td>
                        <td>${formatCurrency(Math.round(totalPayment))}</td>
                    `;
                    scheduleBody.appendChild(row);
                }

                document.getElementById('scheduleTable').style.display = 'block';
            }
        }

        // Thêm event listener cho input thời hạn vay
        document.getElementById('loanTerm').addEventListener('input', function(e) {
            const term = parseInt(e.target.value) || 0;
            const fixedPackage = document.getElementById('fixedPackage');
            const options = fixedPackage.options;

            // Disable các gói không phù hợp với thời hạn vay
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                if (option.value === 'young_1' || option.value === 'young_2') {
                    // Gói ưu đãi đặc biệt chỉ áp dụng cho khoản vay từ 60 tháng trở lên
                    option.disabled = term < 60;
                } else {
                    // Các gói thông thường
                    const packageMonths = parseInt(option.value);
                    option.disabled = term < packageMonths;
                }
            }

            // Nếu gói hiện tại bị disable, chọn gói phù hợp nhất
            if (fixedPackage.value && options[fixedPackage.selectedIndex].disabled) {
                let suitablePackage = null;
                for (let i = options.length - 1; i >= 0; i--) {
                    if (!options[i].disabled) {
                        suitablePackage = options[i].value;
                        break;
                    }
                }
                if (suitablePackage) {
                    fixedPackage.value = suitablePackage;
                }
            }
        });

        // Hàm reset form
        function resetForm() {
            document.getElementById('assetValue').value = '';
            document.getElementById('loanAmount').value = '';
            document.getElementById('loanTerm').value = '';
            document.getElementById('fixedPackage').value = '12';
            document.getElementById('afterFixedRate').value = '9.0';
            document.getElementById('scheduleTable').style.display = 'none';

            // Reset trạng thái disable của các gói
            const fixedPackage = document.getElementById('fixedPackage');
            const options = fixedPackage.options;
            for (let i = 0; i < options.length; i++) {
                options[i].disabled = false;
            }
        }

        // Load dữ liệu từ index.html khi trang được tải
        window.addEventListener('load', function() {
            const loanData = JSON.parse(localStorage.getItem('loanData')) || {};
            
            if (loanData.assetValue && loanData.loanAmount && loanData.loanTerm) {
                document.getElementById('assetValue').value = formatNumber(loanData.assetValue);
                document.getElementById('loanAmount').value = formatNumber(loanData.loanAmount);
                document.getElementById('loanTerm').value = loanData.loanTerm;
                
                // Trigger sự kiện input để kiểm tra và disable các gói không phù hợp
                document.getElementById('loanTerm').dispatchEvent(new Event('input'));
                
                calculateSchedule();
            }
        });

        // Thêm định dạng số cho các input tiền
        ['assetValue', 'loanAmount'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\./g, '');
                if (value) {
                    if (value.length > 12) {
                        value = value.slice(0, 12);
                    }
                    value = parseInt(value);
                    e.target.value = formatNumber(value);
                }
            });
        });

        // Thêm event listener cho input số tiền vay
        document.getElementById('loanAmount').addEventListener('input', function(e) {
            const assetValue = parseFormattedNumber(document.getElementById('assetValue').value);
            const loanAmount = parseFormattedNumber(e.target.value);
            
            if (loanAmount > assetValue) {
                e.target.classList.add('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback';
                    div.textContent = 'Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!';
                    e.target.parentNode.insertBefore(div, e.target.nextSibling);
                }
            } else {
                e.target.classList.remove('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
            }
        });

        // Thêm event listener cho input giá trị tài sản
        document.getElementById('assetValue').addEventListener('input', function(e) {
            const assetValue = parseFormattedNumber(e.target.value);
            const loanAmount = parseFormattedNumber(document.getElementById('loanAmount').value);
            
            if (loanAmount > assetValue) {
                const loanAmountInput = document.getElementById('loanAmount');
                loanAmountInput.classList.add('is-invalid');
                const feedback = loanAmountInput.nextElementSibling;
                if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback';
                    div.textContent = 'Số tiền vay không được vượt quá giá trị tài sản mua/Tài sản bảo đảm!';
                    loanAmountInput.parentNode.insertBefore(div, loanAmountInput.nextSibling);
                }
            }
        });
    </script>
</body>
</html> 