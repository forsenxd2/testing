<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng chào</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .container {
            position: relative;
            z-index: 1;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .form-container {
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 30px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .form-label {
            font-weight: bold;
            margin-bottom: 8px;
        }
        .form-control {
            border-radius: 6px;
            padding: 10px 15px;
        }
        .generate-btn {
            background-color: #228B22;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 16px rgba(34,139,34,0.2);
            transition: all 0.3s ease;
            width: 100%;
        }
        .generate-btn:hover {
            background-color: #1a6f1a;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34,139,34,0.3);
        }
        .generate-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .preview-container {
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        #documentPreview {
            max-width: 100%;
            background: white;
            padding: 20px;
            margin: 0 auto;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        #qrCodeContainer {
            display: inline-block;
            margin-left: 20px;
            vertical-align: top;
        }
        .contact-info {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="header-container">
            <h1 class="mb-0">Bảng chào</h1>
            <button type="button" class="btn btn-secondary btn-sm fw-bold" onclick="window.location.href='index.html'">
                <i class="bi bi-arrow-left"></i> Quay lại
            </button>
        </div>
        
        <div class="form-container">
            <h3 class="mb-4">Nhập thông tin</h3>
            <form id="infoForm">
                <div class="mb-3">
                    <label for="ten" class="form-label">Tên</label>
                    <input type="text" class="form-control" id="ten" placeholder="Nhập tên">
                </div>
                <div class="mb-3">
                    <label for="soDT" class="form-label">Số điện thoại</label>
                    <input type="text" class="form-control" id="soDT" placeholder="Nhập số điện thoại">
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="createQR" checked>
                        <label class="form-check-label" for="createQR">
                            Tạo QR code Zalo
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="text" class="form-control" id="email" placeholder="Nhập email">
                </div>
                <div class="mb-3" style="display: none;">
                    <label for="address" class="form-label">Địa chỉ</label>
                    <input type="text" class="form-control" id="address" placeholder="Nhập địa chỉ" value="55-56 Song Hanh street, Binh Trung ward, Ho Chi Minh City">
                </div>
                <button type="submit" class="generate-btn" id="generateBtn">
                    <i class="bi bi-file-earmark-image"></i> Tạo và tải file PNG
                </button>
                <small class="form-text text-muted d-block mt-2">Lưu ý: Nếu để trống tất cả, sẽ tải file ảnh gốc</small>
            </form>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Đang xử lý...</span>
            </div>
            <p class="mt-3">Đang tạo file, vui lòng đợi...</p>
        </div>
        
        <div class="preview-container" id="previewContainer">
            <h4 class="mb-3">Xem trước</h4>
            <div id="documentPreview"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let baseImage = null;

        // Load ảnh base khi trang load
        async function loadBaseImage() {
            return new Promise((resolve, reject) => {
                // Thử load file jpg trước (vì có vẻ file png không tồn tại)
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    baseImage = img;
                    resolve(img);
                };
                img.onerror = () => {
                    // Thử load file png nếu jpg không có
                    const img2 = new Image();
                    img2.crossOrigin = 'anonymous';
                    img2.onload = () => {
                        baseImage = img2;
                        resolve(img2);
                    };
                    img2.onerror = () => {
                        reject(new Error('Không thể load file ảnh bangchao'));
                    };
                    img2.src = 'images/bangchao.png';
                };
                img.src = 'images/bangchao.jpg';
            });
        }

        // Tạo QR code Zalo từ số điện thoại sử dụng API online
        async function generateZaloQR(phoneNumber, size = 300) {
            const zaloUrl = `https://zalo.me/${phoneNumber.replace(/[^0-9]/g, '')}`;
            // Tạo QR code với kích thước lớn hơn để đảm bảo chất lượng khi scale
            const qrSize = Math.max(size, 300); // Tối thiểu 300x300 để đảm bảo chất lượng
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(zaloUrl)}`;
            
            try {
                // Tải QR code từ API và convert sang data URL để đảm bảo hoạt động với html2canvas
                const response = await fetch(qrApiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const blob = await response.blob();
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        if (reader.result) {
                            resolve(reader.result);
                        } else {
                            reject(new Error('Không thể đọc QR code'));
                        }
                    };
                    reader.onerror = () => {
                        reject(new Error('Lỗi khi đọc QR code'));
                    };
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('Lỗi tạo QR code:', error);
                // Thử sử dụng API khác hoặc tạo placeholder
                const altApiUrl = `https://chart.googleapis.com/chart?cht=qr&chs=${qrSize}x${qrSize}&chl=${encodeURIComponent(zaloUrl)}`;
                try {
                    const response = await fetch(altApiUrl);
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = () => reject(new Error('Không thể tạo QR code'));
                        reader.readAsDataURL(blob);
                    });
                } catch (altError) {
                    console.error('Lỗi với API thay thế:', altError);
                    // Trả về một data URL placeholder trống
                    return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUiBDb2RlPC90ZXh0Pjwvc3ZnPg==';
                }
            }
        }

        // Hiển thị preview ảnh gốc
        async function showPreviewImage() {
            try {
                if (!baseImage) {
                    await loadBaseImage();
                }
                const previewDiv = document.getElementById('documentPreview');
                const previewContainer = document.getElementById('previewContainer');
                previewDiv.innerHTML = `<img src="${baseImage.src}" alt="Preview" style="max-width: 100%; height: auto;">`;
                previewContainer.style.display = 'block';
            } catch (error) {
                console.error('Lỗi khi hiển thị preview:', error);
            }
        }

        // Vẽ thông tin liên hệ và QR code lên ảnh
        async function drawContactInfoOnImage(ten, soDT, email, address, createQR) {
            if (!baseImage) {
                await loadBaseImage();
            }

            // Tạo canvas với kích thước bằng ảnh gốc
            const canvas = document.createElement('canvas');
            canvas.width = baseImage.width;
            canvas.height = baseImage.height;
            const ctx = canvas.getContext('2d');

            // Vẽ ảnh gốc lên canvas
            ctx.drawImage(baseImage, 0, 0);

            // Kiểm tra xem có thông tin nào cần vẽ không
            const hasTen = ten && ten.trim();
            const hasSoDT = soDT && soDT.trim();
            const hasEmail = email && email.trim();
            const hasAddress = address && address.trim();

            // Nếu không có thông tin nào, chỉ trả về ảnh gốc
            if (!hasTen && !hasSoDT && !hasEmail && !hasAddress) {
                return canvas;
            }

            // Tính toán vị trí và kích thước font dựa trên kích thước ảnh
            // Căn lề trái để thẳng với bảng trên (ước tính bảng bắt đầu từ khoảng 7-8% từ lề trái)
            const textX = baseImage.width * 0.126; // 7.5% từ lề trái để thẳng với bảng trên
            const startY = baseImage.height * 0.84; // 85% từ trên xuống (gần cuối ảnh)
            
            // Tính toán vị trí QR code: căn bên phải, to gấp 1.8 lần
            const baseQRSize = Math.min(150, baseImage.width * 0.08); // Kích thước cơ bản
            const qrSize = baseQRSize * 1.8; // To gấp 1.8 lần
            const qrX = baseImage.width - qrSize - (baseImage.width * 0.072); // Căn bên phải, cách lề phải bằng khoảng cách lề trái
            
            // Log để debug
            console.log('QR Code size:', qrSize, 'Base size:', baseQRSize, 'Image width:', baseImage.width);
            
            // Tính font size dựa trên chiều rộng ảnh (tỷ lệ với ảnh gốc)
            const baseFontSize = Math.max(14, baseImage.width / 50); // Font size tỷ lệ với ảnh
            const titleFontSize = baseFontSize + 2;
            const textFontSize = baseFontSize;

            // Cấu hình font cho tiêu đề - sử dụng font Inter (Google Fonts) hoặc fallback
            ctx.fillStyle = '#000000';
            ctx.font = `600 ${titleFontSize}px 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';

            // Vẽ tiêu đề "Thông tin liên hệ:" chỉ khi có ít nhất một thông tin
            ctx.fillText('Thông tin liên hệ:', textX, startY);

            // Cấu hình font cho nội dung - sử dụng font Inter với weight 400 (regular)
            ctx.font = `400 ${textFontSize}px 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif`;
            const lineHeight = textFontSize * 1.5;

            let currentY = startY + lineHeight;

            // Vẽ tên và số điện thoại nếu có
            if (hasTen || hasSoDT) {
                let lineText = '';
                if (hasTen) {
                    lineText = ten.trim();
                }
                if (hasSoDT) {
                    if (lineText) {
                        lineText += ` – Tel: ${soDT.trim()}`;
                    } else {
                        lineText = `Tel: ${soDT.trim()}`;
                    }
                }
                ctx.fillText(lineText, textX, currentY);
                currentY += lineHeight;
            }

            // Vẽ email nếu có
            if (hasEmail) {
                ctx.fillText(`Email: ${email.trim()}`, textX, currentY);
                currentY += lineHeight;
            }

            // Vẽ địa chỉ nếu có - chia thành 2 dòng sau "street,"
            if (hasAddress) {
                const addressText = address.trim();
                // Tìm vị trí "street," (có dấu phẩy) hoặc "street" để chia dòng
                const streetCommaIndex = addressText.toLowerCase().indexOf('street,');
                const streetIndex = addressText.toLowerCase().indexOf('street');
                
                if (streetCommaIndex !== -1) {
                    // Tìm thấy "street," - lấy đến hết dấu phẩy
                    const part1 = addressText.substring(0, streetCommaIndex + 7); // Bao gồm cả "street,"
                    const part2 = addressText.substring(streetCommaIndex + 7).trim(); // Phần còn lại
                    
                    // Vẽ dòng đầu: "Address: 55-56 Song Hanh street,"
                    ctx.fillText(`Address: ${part1}`, textX, currentY);
                    currentY += lineHeight;
                    
                    // Vẽ dòng thứ hai: "Binh Trung ward, Ho Chi Minh City"
                    if (part2) {
                        ctx.fillText(part2, textX, currentY);
                        currentY += lineHeight;
                    }
                } else if (streetIndex !== -1) {
                    // Chỉ tìm thấy "street" không có dấu phẩy - thêm dấu phẩy vào
                    const part1 = addressText.substring(0, streetIndex + 6) + ','; // Bao gồm cả "street" và thêm dấu phẩy
                    const part2 = addressText.substring(streetIndex + 6).trim(); // Phần còn lại
                    
                    // Vẽ dòng đầu: "Address: 55-56 Song Hanh street,"
                    ctx.fillText(`Address: ${part1}`, textX, currentY);
                    currentY += lineHeight;
                    
                    // Vẽ dòng thứ hai: "Binh Trung ward, Ho Chi Minh City"
                    if (part2) {
                        ctx.fillText(part2, textX, currentY);
                        currentY += lineHeight;
                    }
                } else {
                    // Nếu không tìm thấy "street", vẽ bình thường
                    ctx.fillText(`Address: ${addressText}`, textX, currentY);
                    currentY += lineHeight;
                }
            }

            // Vẽ QR code Zalo nếu có số điện thoại và checkbox được tick
            if (hasSoDT && createQR) {
                try {
                    // Tạo QR code với kích thước lớn hơn để đảm bảo chất lượng khi scale
                    const qrCodeDataUrl = await generateZaloQR(soDT, qrSize);
                    const qrImage = new Image();
                    await new Promise((resolve, reject) => {
                        qrImage.onload = resolve;
                        qrImage.onerror = reject;
                        qrImage.src = qrCodeDataUrl;
                    });

                    // Tính toán vị trí QR code: căn dưới để phần dưới cùng của QR code thẳng với phần dưới cùng của thông tin liên hệ
                    // currentY là vị trí dưới cùng của thông tin liên hệ
                    // qrY + qrSize = currentY => qrY = currentY - qrSize
                    const qrY = currentY - qrSize-13; // Căn dưới để thẳng với phần dưới cùng của thông tin liên hệ

                    console.log('Drawing QR code at:', qrX, qrY, 'size:', qrSize);

                    // Vẽ QR code (bỏ chữ Zalo)
                    ctx.drawImage(qrImage, qrX, qrY, qrSize, qrSize);
                } catch (error) {
                    console.error('Lỗi khi vẽ QR code:', error);
                    // Tiếp tục không có QR code nếu lỗi
                }
            }

            return canvas;
        }

        // Xử lý form submit
        document.getElementById('infoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const ten = document.getElementById('ten').value.trim();
            const soDT = document.getElementById('soDT').value.trim();
            const email = document.getElementById('email').value.trim();
            const address = document.getElementById('address').value.trim();
            const createQR = document.getElementById('createQR').checked;

            const generateBtn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');
            const previewContainer = document.getElementById('previewContainer');

            generateBtn.disabled = true;
            loading.style.display = 'block';
            previewContainer.style.display = 'none';

            try {
                // Đảm bảo ảnh base đã được load
                if (!baseImage) {
                    await loadBaseImage();
                }

                // Vẽ thông tin liên hệ và QR code lên ảnh (có thể để trống tất cả)
                console.log('Bắt đầu vẽ thông tin lên ảnh...');
                const canvas = await drawContactInfoOnImage(ten, soDT, email, address, createQR);

                console.log('Canvas đã được tạo:', canvas.width, 'x', canvas.height);

                // Hiển thị preview với ảnh đã vẽ
                const previewDiv = document.getElementById('documentPreview');
                previewDiv.innerHTML = `<img src="${canvas.toDataURL('image/png')}" alt="Preview" style="max-width: 100%; height: auto;">`;
                previewContainer.style.display = 'block';
                previewContainer.style.position = 'relative';
                previewContainer.style.left = 'auto';
                previewContainer.style.top = 'auto';
                previewContainer.style.zIndex = 'auto';

                const finalCanvas = canvas;

                // Hàm helper để tải file
                const downloadFile = (canvas) => {
                    try {
                        const dataUrl = canvas.toDataURL('image/png', 0.95);
                        if (!dataUrl || dataUrl === 'data:,') {
                            throw new Error('Không thể tạo data URL từ canvas');
                        }
                        console.log('Data URL length:', dataUrl.length);
                        
                        const link = document.createElement('a');
                        link.download = 'bangchao.png';
                        link.href = dataUrl;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        // Hiển thị preview (đưa về vị trí bình thường)
                        previewContainer.style.position = 'relative';
                        previewContainer.style.left = 'auto';
                        previewContainer.style.top = 'auto';
                        previewContainer.style.display = 'block';
                        generateBtn.disabled = false;
                        loading.style.display = 'none';
                    } catch (error) {
                        console.error('Lỗi khi tạo download link:', error);
                        alert('Lỗi khi tải file: ' + error.message);
                        generateBtn.disabled = false;
                        loading.style.display = 'none';
                    }
                };

                // Tải file PNG - thử dùng blob trước, nếu lỗi thì dùng data URL
                try {
                    // Thử dùng blob trước
                    finalCanvas.toBlob(function(blob) {
                        if (!blob || blob.size === 0) {
                            console.warn('Blob không hợp lệ, thử dùng data URL...');
                            // Fallback: dùng data URL
                            downloadFile(finalCanvas);
                        } else {
                            console.log('Blob size:', blob.size, 'bytes');
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.download = 'bangchao.png';
                            link.href = url;
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();
                            
                            // Đợi một chút trước khi cleanup
                            setTimeout(() => {
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                            }, 100);

                            // Hiển thị preview (đưa về vị trí bình thường)
                            previewContainer.style.position = 'relative';
                            previewContainer.style.left = 'auto';
                            previewContainer.style.top = 'auto';
                            previewContainer.style.display = 'block';
                            generateBtn.disabled = false;
                            loading.style.display = 'none';
                        }
                    }, 'image/png', 0.95);
                } catch (error) {
                    console.error('Lỗi khi tạo blob:', error);
                    // Fallback: dùng data URL
                    downloadFile(finalCanvas);
                }

            } catch (error) {
                console.error('Lỗi:', error);
                alert('Có lỗi xảy ra: ' + error.message);
                generateBtn.disabled = false;
                loading.style.display = 'none';
            }
        });

        // Load ảnh base và hiển thị preview khi trang load
        window.addEventListener('load', async function() {
            await loadBaseImage();
            await showPreviewImage();
        });
    </script>
</body>
</html> 