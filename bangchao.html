<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng chào</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .container {
            position: relative;
            z-index: 1;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .form-container {
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 30px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .form-label {
            font-weight: bold;
            margin-bottom: 8px;
        }
        .form-control {
            border-radius: 6px;
            padding: 10px 15px;
        }
        .generate-btn {
            background-color: #228B22;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 16px rgba(34,139,34,0.2);
            transition: all 0.3s ease;
            width: 100%;
        }
        .generate-btn:hover {
            background-color: #1a6f1a;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34,139,34,0.3);
        }
        .generate-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .preview-container {
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        #documentPreview {
            max-width: 100%;
            background: white;
            padding: 20px;
            margin: 0 auto;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        #qrCodeContainer {
            display: inline-block;
            margin-left: 20px;
            vertical-align: top;
        }
        .contact-info {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="header-container">
            <h1 class="mb-0">Bảng chào</h1>
            <button type="button" class="btn btn-secondary btn-sm fw-bold" onclick="window.location.href='index.html'">
                <i class="bi bi-arrow-left"></i> Quay lại
            </button>
        </div>
        
        <div class="form-container">
            <h3 class="mb-4">Nhập thông tin</h3>
            <form id="infoForm">
                <div class="mb-3">
                    <label for="canBo" class="form-label">Cán bộ</label>
                    <input type="text" class="form-control" id="canBo" placeholder="Nhập tên cán bộ" required>
                </div>
                <div class="mb-3">
                    <label for="soDT" class="form-label">Số điện thoại</label>
                    <input type="tel" class="form-control" id="soDT" placeholder="Nhập số điện thoại" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" placeholder="Nhập email" required>
                </div>
                <button type="submit" class="generate-btn" id="generateBtn">
                    <i class="bi bi-file-earmark-image"></i> Tạo và tải file PNG
                </button>
            </form>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Đang xử lý...</span>
            </div>
            <p class="mt-3">Đang tạo file, vui lòng đợi...</p>
        </div>
        
        <div class="preview-container" id="previewContainer">
            <h4 class="mb-3">Xem trước</h4>
            <div id="documentPreview"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        let docxContent = null;

        // Load và convert DOCX sang HTML khi trang load
        async function loadDocx() {
            try {
                const response = await fetch('images/bangchao.docx');
                const arrayBuffer = await response.arrayBuffer();
                const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                docxContent = result.value;
            } catch (error) {
                console.error('Lỗi khi load file DOCX:', error);
                alert('Không thể load file DOCX. Vui lòng kiểm tra lại file.');
            }
        }

        // Tạo QR code Zalo từ số điện thoại sử dụng API online
        async function generateZaloQR(phoneNumber) {
            const zaloUrl = `https://zalo.me/${phoneNumber.replace(/[^0-9]/g, '')}`;
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(zaloUrl)}`;
            
            try {
                // Tải QR code từ API và convert sang data URL để đảm bảo hoạt động với html2canvas
                const response = await fetch(qrApiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const blob = await response.blob();
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        if (reader.result) {
                            resolve(reader.result);
                        } else {
                            reject(new Error('Không thể đọc QR code'));
                        }
                    };
                    reader.onerror = () => {
                        reject(new Error('Lỗi khi đọc QR code'));
                    };
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('Lỗi tạo QR code:', error);
                // Thử sử dụng API khác hoặc tạo placeholder
                const altApiUrl = `https://chart.googleapis.com/chart?cht=qr&chs=150x150&chl=${encodeURIComponent(zaloUrl)}`;
                try {
                    const response = await fetch(altApiUrl);
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = () => reject(new Error('Không thể tạo QR code'));
                        reader.readAsDataURL(blob);
                    });
                } catch (altError) {
                    console.error('Lỗi với API thay thế:', altError);
                    // Trả về một data URL placeholder trống
                    return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUiBDb2RlPC90ZXh0Pjwvc3ZnPg==';
                }
            }
        }

        // Điền thông tin vào nội dung DOCX
        function fillDocumentContent(canBo, soDT, email) {
            if (!docxContent) {
                throw new Error('Nội dung DOCX chưa được load');
            }

            // Tạo một div tạm để chứa HTML từ DOCX
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = docxContent;

            // Tạo HTML mới với thông tin đã điền
            let newContent = docxContent;
            
            // Tìm và thay thế các pattern có thể có trong DOCX
            // Pattern 1: "Mr. [Tên] – Tel: [SĐT]"
            newContent = newContent.replace(/Mr\.\s*[^–<]*–\s*Tel:\s*[0-9.\s]*/gi, `image.png ${canBo} – Tel: ${soDT}`);
            
            // Pattern 2: Tìm "Tel:" hoặc "Điện thoại:" và thay thế
            newContent = newContent.replace(/(Tel|Điện thoại):\s*[0-9.\s]*/gi, `$1: ${soDT}`);
            
            // Pattern 3: Tìm và thay thế email
            newContent = newContent.replace(/Email:\s*[^\s<@]*@[^\s<]*/gi, `Email: ${email}`);
            newContent = newContent.replace(/email:\s*[^\s<@]*@[^\s<]*/gi, `Email: ${email}`);
            
            // Pattern 4: Tìm tên cán bộ (sau "Mr." hoặc trong thông tin liên hệ)
            const namePatterns = [
                /Mr\.\s+[^–<]*/gi,
                /Cán bộ:\s*[^<]*/gi,
                /Người liên hệ:\s*[^<]*/gi
            ];
            
            namePatterns.forEach(pattern => {
                if (pattern.test(newContent)) {
                    newContent = newContent.replace(pattern, (match) => {
                        if (match.includes('Mr.')) {
                            return `Mr. ${canBo}`;
                        }
                        return match.replace(/:\s*[^<]*/, `: ${canBo}`);
                    });
                }
            });

            // Kiểm tra xem đã thay thế được thông tin chưa
            const hasContactInfo = newContent.includes(canBo) && newContent.includes(soDT) && newContent.includes(email);
            
            // Nếu chưa thay thế được, thêm thông tin mới vào cuối
            if (!hasContactInfo) {
                const contactInfoHtml = `
                    <div style="margin-top: 20px;">
                        <p><strong>Thông tin liên hệ:</strong></p>
                        <p>Mr. ${canBo} – Tel: ${soDT}</p>
                        <p>Email: ${email}</p>
                    </div>
                `;
                newContent += contactInfoHtml;
            }

            return newContent;
        }

        // Xử lý form submit
        document.getElementById('infoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const canBo = document.getElementById('canBo').value.trim();
            const soDT = document.getElementById('soDT').value.trim();
            const email = document.getElementById('email').value.trim();

            if (!canBo || !soDT || !email) {
                alert('Vui lòng điền đầy đủ thông tin');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');
            const previewContainer = document.getElementById('previewContainer');

            generateBtn.disabled = true;
            loading.style.display = 'block';
            previewContainer.style.display = 'none';

            try {
                // Đảm bảo DOCX đã được load
                if (!docxContent) {
                    await loadDocx();
                }

                // Điền thông tin vào document
                let filledContent = fillDocumentContent(canBo, soDT, email);

                // Tạo container để render document
                const previewDiv = document.getElementById('documentPreview');
                
                // Đảm bảo previewDiv hiển thị và có kích thước
                previewDiv.innerHTML = filledContent;
                previewDiv.style.display = 'block';
                previewDiv.style.visibility = 'visible';
                previewDiv.style.position = 'relative';
                previewDiv.style.width = 'auto';
                previewDiv.style.minWidth = '800px'; // Đặt min width để đảm bảo có kích thước
                
                // Hiển thị preview container để đảm bảo element được render
                // Nhưng đặt ngoài viewport để không ảnh hưởng UI
                previewContainer.style.display = 'block';
                previewContainer.style.visibility = 'visible';
                previewContainer.style.position = 'fixed';
                previewContainer.style.left = '-10000px';
                previewContainer.style.top = '0';
                previewContainer.style.zIndex = '-1';

                // Đợi một chút để render xong
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Kiểm tra kích thước của previewDiv
                const rect = previewDiv.getBoundingClientRect();
                console.log('PreviewDiv size:', rect.width, 'x', rect.height);
                
                if (rect.width === 0 || rect.height === 0) {
                    // Nếu không có kích thước, đặt kích thước mặc định
                    previewDiv.style.width = '800px';
                    previewDiv.style.height = 'auto';
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // Convert sang PNG
                console.log('Bắt đầu convert sang PNG...');
                const canvas = await html2canvas(previewDiv, {
                    backgroundColor: '#ffffff',
                    scale: 1.5,
                    logging: false,
                    useCORS: true,
                    allowTaint: false,
                    windowWidth: Math.max(previewDiv.scrollWidth || 800, 800),
                    windowHeight: Math.max(previewDiv.scrollHeight || 600, 600)
                });

                console.log('Canvas đã được tạo:', canvas.width, 'x', canvas.height);

                // Kiểm tra canvas có hợp lệ không
                let finalCanvas = canvas;
                if (!canvas || canvas.width === 0 || canvas.height === 0) {
                    // Thử lại với options khác
                    console.log('Thử lại với options khác...');
                    const canvas2 = await html2canvas(previewDiv, {
                        backgroundColor: '#ffffff',
                        scale: 1,
                        logging: false,
                        useCORS: true,
                        allowTaint: true
                    });
                    
                    if (!canvas2 || canvas2.width === 0 || canvas2.height === 0) {
                        throw new Error('Canvas không hợp lệ hoặc có kích thước 0. PreviewDiv size: ' + rect.width + 'x' + rect.height);
                    }
                    
                    finalCanvas = canvas2;
                }

                // Hàm helper để tải bằng data URL
                const downloadAsDataURL = (canvas, canBo) => {
                    try {
                        const dataUrl = canvas.toDataURL('image/png', 0.95);
                        if (!dataUrl || dataUrl === 'data:,') {
                            throw new Error('Không thể tạo data URL từ canvas');
                        }
                        console.log('Data URL length:', dataUrl.length);
                        
                        const link = document.createElement('a');
                        link.download = `bangchao_${canBo.replace(/\s+/g, '_')}.png`;
                        link.href = dataUrl;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        // Hiển thị preview (đưa về vị trí bình thường)
                        previewContainer.style.position = 'relative';
                        previewContainer.style.left = 'auto';
                        previewContainer.style.top = 'auto';
                        previewContainer.style.display = 'block';
                        generateBtn.disabled = false;
                        loading.style.display = 'none';
                    } catch (error) {
                        console.error('Lỗi khi tạo download link:', error);
                        alert('Lỗi khi tải file: ' + error.message);
                        generateBtn.disabled = false;
                        loading.style.display = 'none';
                    }
                };

                // Tải file PNG - thử dùng blob trước, nếu lỗi thì dùng data URL
                try {
                    // Thử dùng blob trước
                    finalCanvas.toBlob(function(blob) {
                        if (!blob || blob.size === 0) {
                            console.warn('Blob không hợp lệ, thử dùng data URL...');
                            // Fallback: dùng data URL
                            downloadAsDataURL(finalCanvas, canBo);
                        } else {
                            console.log('Blob size:', blob.size, 'bytes');
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.download = `bangchao_${canBo.replace(/\s+/g, '_')}.png`;
                            link.href = url;
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();
                            
                            // Đợi một chút trước khi cleanup
                            setTimeout(() => {
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                            }, 100);

                            // Hiển thị preview (đưa về vị trí bình thường)
                            previewContainer.style.position = 'relative';
                            previewContainer.style.left = 'auto';
                            previewContainer.style.top = 'auto';
                            previewContainer.style.display = 'block';
                            generateBtn.disabled = false;
                            loading.style.display = 'none';
                        }
                    }, 'image/png', 0.95);
                } catch (error) {
                    console.error('Lỗi khi tạo blob:', error);
                    // Fallback: dùng data URL
                    downloadAsDataURL(finalCanvas, canBo);
                }

            } catch (error) {
                console.error('Lỗi:', error);
                alert('Có lỗi xảy ra: ' + error.message);
                generateBtn.disabled = false;
                loading.style.display = 'none';
            }
        });

        // Load DOCX khi trang load
        window.addEventListener('load', loadDocx);
    </script>
</body>
</html> 